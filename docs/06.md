# Advanced Jenkins ì‚¬ìš© 2 - SonarQube, Multi nodes
## 1. SonarQube ì‚¬ìš©í•˜ê¸°
ì •ì  ë¶„ì„ ë„êµ¬ SonarQubeì™€ Jenkins ì—°ë™

### SonarQube íŠ¹ì§•
- Continuous Integration + Analysis (ì§€ì†ì ì¸ í†µí•©ê³¼ ë¶„ì„ì„ í•  ë•Œ ì‚¬ìš©í•˜ëŠ” ì†”ë£¨ì…˜)
  - ì½”ë“œì— ëŒ€í•œ í’ˆì§ˆì„ ë†’ì´ê¸° ìœ„í•´ì„œ ì½”ë“œê°€ ê°€ì§„ Issue, Defect, ë³µì¡ì„±ì„ ë¶„ì„
  - Detect Bugs & Vulnerabilities
  - Track Code Smells: ì½”ë“œì•ˆì— ë¶ˆí•„ìš”í•œ ì½”ë“œ, ì´ìƒ ì—¬ë¶€ë¥¼ íƒì§€
  - ì½”ë“œì˜ í’ˆì§ˆì„ ë†’ì—¬ì£¼ëŠ” ìš©ë„ë¡œ ì‚¬ìš©
- 17 languages ì§€ì›
  - Java, C#, JavaScript, CloudFormation, Terraform, Kotlin, Ruby, Go, Scala, Flex, Python, PHP, HTML, CSS, XML, VB.NET
- CI/CD Integration
- Extensible, with 50+community plugins

<br>

### Install SonalQube
<img src="https://github.com/hyewon218/Building-CI-CD-pipelines-with-Jenkins/assets/126750615/5fa84651-fed4-4035-a3cf-af5e4104b7c7" width="60%"/><br>
<img src="https://github.com/hyewon218/Building-CI-CD-pipelines-with-Jenkins/assets/126750615/22331733-f2e8-4bb7-b05c-465cbb055950" width="60%"/><br>
```
docker pull sonarqube
docker run --rm -p 9000:9000 --name sonarqube sonarqube
```
m1
```
docker pull edowon0623/sonarqube:arm
docker run --rm -p 9000:9000 --name sonarqube edowon0623/sonarqube:arm
```

<br>

### ê²°ê³¼
<img src="https://github.com/hyewon218/Building-CI-CD-pipelines-with-Jenkins/assets/126750615/448460fc-502b-4083-96c7-b32d7a06762b" width="60%"/><br>

<br>

## 2. SonarQube + Maven í”„ë¡œì íŠ¸ ì‚¬ìš©í•˜ê¸°
### Maven Projectì— Plugin ì„¤ì • ì¶”ê°€
  - https://docs.sonarsource.com/sonarqube/latest/analyzing-source-code/scanners/sonarscanner-for-maven/ <br>
    <img src="https://github.com/hyewon218/Building-CI-CD-pipelines-with-Jenkins/assets/126750615/3bfcebe2-9dda-4391-ba7d-6aaf1c6fb926" width="60%"/><br>
  - https://mvnrepository.com/artifact/org.sonarsource.scanner.maven/sonar-maven-plugin <br>
    <img src="https://github.com/hyewon218/Building-CI-CD-pipelines-with-Jenkins/assets/126750615/5cae60c9-ab08-42b5-abc2-4df72c696259" width="60%"/><br>

<br>

<img src="https://github.com/hyewon218/Building-CI-CD-pipelines-with-Jenkins/assets/126750615/22ba100e-d80f-4046-9d02-f90d82523720" width="60%"/><br>
- SonarQube í”ŒëŸ¬ê·¸ì¸ì„ ì¶”ê°€í•˜ê²Œë˜ë©´ Maven ë¹Œë“œë¥¼ í†µí•´ì„œ SonarQubeë¡œ ì •ë³´ë¥¼ ì „ë‹¬í•  ìˆ˜ ìˆë‹¤.

<br>

### SonarQube token ìƒì„±
- My account -> Security -> User Token ìƒì„±<br>
<img src="https://github.com/hyewon218/Building-CI-CD-pipelines-with-Jenkins/assets/126750615/81e7fe69-18b0-4efb-a61e-70679e244634" width="60%"/><br>
<img src="https://github.com/hyewon218/Building-CI-CD-pipelines-with-Jenkins/assets/126750615/6f4084fc-4e23-4c60-8b54-0d0f868dad1a" width="60%"/><br>

<br>

### Maven build
```
brew install mvn
```
```
mvn sonar:sonar -Dsonar.host.url=http://IP_address:9000 -Dsonar.login=[sonar-token]
```

<img src="https://github.com/hyewon218/Building-CI-CD-pipelines-with-Jenkins/assets/126750615/550d7346-e89f-46b6-9fdf-fffd15449936" width="60%"/><br>
<img src="https://github.com/hyewon218/Building-CI-CD-pipelines-with-Jenkins/assets/126750615/2cacecca-db6b-4233-a26d-911bacc4e7ab" width="60%"/><br>

<br>

### SonarQube Projects í™•ì¸
<img src="https://github.com/hyewon218/Building-CI-CD-pipelines-with-Jenkins/assets/126750615/0fc9ed03-6511-4eb9-96d3-8c84aeec064d" width="60%"/><br>
- íŠ¹ë³„í•œ ë¬¸ì œê°€ ì—†ê¸° ë•Œë¬¸ì— passed ë¼ê³  í‘œì‹œ

<br>

## 3. Bad code ì¡°ì‚¬í•˜ê¸°
### ìƒ˜í”Œ í”„ë¡œì íŠ¸ì— ì•„ë˜ ì½”ë“œ ì¶”ê°€
```java
@Controller
public class WelcomeController {

    private final Logger logger = LoggerFactory.getLogger(WelcomeController.class);

    @GetMapping("/")
    public String index(Model model) {
        logger.debug("Welcome to njonecompany.com...");

        model.addAttribute("msg", getMessage());
        model.addAttribute("today", new Date());

        System.out.println("index is called by GET /");
        return "index";
    }
}
```
- ìœ„ ì½”ë“œì²˜ëŸ¼ print ë¬¸ì¥ ì‚½ì…
- print ë¬¸ì¥ì´ ë¬¸ì œê°€ ë˜ëŠ” ë¶€ë¶„ì€ ì•„ë‹ˆì§€ë§Œ ì‹¤ì œ ìš´ì˜ì„œë²„ì— print ë¬¸ì¥ì— ì˜í•´ IOì— ëŒ€í•œ ë¦¬ì†ŒìŠ¤ë¥¼ ì‚¬ìš©í•˜ê¸° ë•Œë¬¸ì— í”„ë¡œì íŠ¸ ì„±ëŠ¥ì„ ë‚®ì¶˜ë‹¤.

<br>

### ê²°ê³¼
```
mvn clean complie package -DskipTests=true
```

<img src="https://github.com/hyewon218/Building-CI-CD-pipelines-with-Jenkins/assets/126750615/7566f1ec-790a-4f34-9713-887d96f43226" width="60%"/><br>
<img src="https://github.com/hyewon218/Building-CI-CD-pipelines-with-Jenkins/assets/126750615/048e3bec-8e00-4a21-9eb4-8c94727d2f01" width="60%"/><br>

<img src="https://github.com/hyewon218/Building-CI-CD-pipelines-with-Jenkins/assets/126750615/c1838a5d-8f46-415b-adf9-dfb506725170" width="60%"/><br>
<img src="https://github.com/hyewon218/Building-CI-CD-pipelines-with-Jenkins/assets/126750615/40d7427f-53fe-4baa-b257-364f20fe8af3" width="60%"/><br>
-  ìœ„ì™€ ê°™ì€ ê²°ê³¼ë¥¼ í‘œì‹œí•´ì¤Œìœ¼ë¡œì¨ SonarQubeì—ì„œ í†µê³¼ë˜ì§€ ì•ŠëŠ” ê²½ìš°ì— ë¹Œë“œ ì‘ì—…ì„ ì§„í–‰í•˜ì§€ ì•Šê³  ì½”ë“œë¥¼ ê°œì„ í•œ í›„ì— ë‹¤ì‹œ SonarQubeì—ì„œ ë¬¸ì œê°€ ì—†ëŠ” ê²½ìš°ì— CI/CD ì‘ì—…ì„ ì§„í–‰

<br>

## 4. Jenkins + SonarQube ì—°ë™
- Jenkins ê´€ë¦¬ -> í”ŒëŸ¬ê·¸ì¸ ê´€ë¦¬ -> ì„¤ì¹˜ê°€ëŠ¥ -> SonarQube Scanner
  <img src="https://github.com/hyewon218/Building-CI-CD-pipelines-with-Jenkins/assets/126750615/a839e00d-090e-4217-be0f-b4f14ba12b47" width="60%"/><br>
- Jenkins ê´€ë¦¬ -> Manage Credentials -> Add Credentials
  <img src="https://github.com/hyewon218/Building-CI-CD-pipelines-with-Jenkins/assets/126750615/614d9fd9-901b-41c3-ad5f-b21b72dd83fb" width="60%"/><br>

  <img src="https://github.com/hyewon218/Building-CI-CD-pipelines-with-Jenkins/assets/126750615/3bba0597-4ee2-43b7-be6f-d19c55d3edb1" width="60%"/><br>
  <img src="https://github.com/hyewon218/Building-CI-CD-pipelines-with-Jenkins/assets/126750615/3471201d-f24c-4f0a-a2bf-42f7e62dff06" width="60%"/><br>

- Jenkins ê´€ë¦¬ -> Configure System -> SonarQube servers
  <img src="https://github.com/hyewon218/Building-CI-CD-pipelines-with-Jenkins/assets/126750615/0c41a5d3-f07b-4e7a-8e9c-9b7e1657328a" width="60%"/><br>
  - docker inspect network bridge ë¥¼ í†µí•´ ip í™•ì¸

<br>

## 5. SonarQube ì‚¬ìš©ì„ ìœ„í•œ Pipeline ì‚¬ìš©í•˜ê¸°
- My-Third-Pipeline ìˆ˜ì •<br>
  <img src="https://github.com/hyewon218/Building-CI-CD-pipelines-with-Jenkins/assets/126750615/46638abe-1828-4482-ab23-669ea7db2354" width="60%"/><br>

### ê²°ê³¼
<img src="https://github.com/hyewon218/Building-CI-CD-pipelines-with-Jenkins/assets/126750615/34c4f081-fcc9-44b2-9f14-27ec0ab226f1" width="60%"/><br>

<br>

## 6. Jenkins Multi nodes êµ¬ì„±í•˜ê¸° - Master + Slaves
### Jenkins Master + Slaves
<img src="https://github.com/hyewon218/Building-CI-CD-pipelines-with-Jenkins/assets/126750615/6e8d791d-8eed-411f-a590-d0f846f6dbb5" width="60%"/><br>
> í˜„ì¬ê¹Œì§€ Jenkinsë¥¼ ë‹¨ì¼ ì„œë²„ë¡œ êµ¬ì„±í•˜ì—¬ ì‚¬ìš© -> Jenkins Master<br>
> Jenkins Master ì—ì„œ ì‚¬ìš©ìì˜ ìš”ì²­ì— ì˜í•´ì„œ ë¹Œë“œ, ë°°í¬í•˜ëŠ” ì‘ì—…ì„ ì§„í–‰í–ˆë‹¤.<br>
> ì´ì œëŠ” ìì‹ ì—ê²Œ ì¶”ê°€ëœ Slave ì—ê²Œ ì‘ì—…ì„ ì „ë‹¬í•˜ì—¬ ì—…ë¬´ë¥¼ ë¶„í• 

<br>

### Jenkins Slave
- Remoteì—ì„œ ì‹¤í–‰ë˜ëŠ” Jenkins ì‹¤í–‰ Worker Node
- Jenkins Master ì˜ ìš”ì²­ ì²˜ë¦¬ -> ë¹Œë“œ, ë°°í¬ì™€ ê°™ì€ ìš”ì²­ ì²˜ë¦¬
- Masterë¡œë¶€í„° ì „ë‹¬ëœ Job ì‹¤í–‰
- ë‹¤ì–‘í•œ ìš´ì˜ì²´ì œì—ì„œ ì‹¤í–‰ ê°€ëŠ¥
- Jenkins í”„ë¡œì íŠ¸ ìƒì„± ì‹œ íŠ¹ì • Slaveë¥¼ ì„ íƒí•˜ì—¬ ì‹¤í–‰ ê°€ëŠ¥
> ì´ë ‡ê²Œ ë¶„í• í•´ì¤Œìœ¼ë¡œì¨ Master Node ëŠ” í´ë¼ì´ì–¸íŠ¸ì˜ ë¹Œë“œ, ë°°í¬ ìš”ì²­ì„ ë°›ì€ ë‹¤ìŒì—<br> 
> ìì‹ ì´ ì§ì ‘ ì²˜ë¦¬í•˜ëŠ” ê²ƒì´ ì•„ë‹Œ ë¦¬ì†ŒìŠ¤ê°€ í™•ë³´ëœ Slave Nodeì— ì‘ì—…ì„ ì „ë‹¬í•˜ê³  ê²°ê³¼ë¥¼ ë°›ì•„ì„œ ì²˜ë¦¬í•  ìˆ˜ ìˆë‹¤.

<br>

## 7. Jenkins Node ì¶”ê°€í•˜ê¸°
### ğŸ“Docker Container í˜•íƒœë¡œ ì¶”ê°€
```
docker run --privileged --name jenkins-node1 -itd -p 30022:22 -e container=docker -v /sys/fs/cgroup:/sys/fs/cgroup:rw --cgroupns=host  edowon0623/docker-server:m1 /usr/sbin/init
```
<img src="https://github.com/hyewon218/Building-CI-CD-pipelines-with-Jenkins/assets/126750615/a7a95ff2-2d51-4f50-abc0-e619781e1d7d" width="60%"/><br>

<br>

### ğŸ“Slave Node JDK ì„¤ì¹˜
```
yum install -y ncurses git
yum list java*jdk-devel - ì„¤ì¹˜ ë²„ì „ í™•ì¸
yum install -y java-11-openjdk-devel.aarch64
```

<br>

### ğŸ“Jenkins Master Node ì—ì„œ Slave Node ë¡œ SSH ì ‘ì†í•˜ê¸° ìœ„í•œ Key ìƒì„±
```
ssh-keygen
ssh-copy-id root@[slave node IP]
```

<br>

### ğŸ“Add a slave node
- Jenkins ê´€ë¦¬ -> ë…¸ë“œ ê´€ë¦¬ -> ì‹ ê·œ ë…¸ë“œ<br>
  <img src="https://github.com/hyewon218/Building-CI-CD-pipelines-with-Jenkins/assets/126750615/3c4b0792-9ef9-4a9c-9533-3559f3093b45" width="60%"/><br>
  <img src="https://github.com/hyewon218/Building-CI-CD-pipelines-with-Jenkins/assets/126750615/eae42727-6d7f-4e74-85d7-bc43782157ab" width="60%"/><br>
  <img src="https://github.com/hyewon218/Building-CI-CD-pipelines-with-Jenkins/assets/126750615/17a33104-bb07-4f6c-93b7-9be46012b76a" width="60%"/><br>
    - **Number of executors** : ì¶”ê°€í•˜ê³  ìˆëŠ” ë…¸ë“œì—ì„œ Master ë¡œ ë¶€í„° ì‘ì—…(ë¹Œë“œ, ë°°í¬ ìš”ì²­)ì„ ë°›ì•˜ì„ ë•Œ ë™ì‹œì— ì²˜ë¦¬í•  ìˆ˜ Jobì˜ ìµœëŒ€ ê°œìˆ˜
    - **Remote root directory** : í•´ë‹¹ ê²½ë¡œë¡œ ë¹Œë“œê°€ ì„±ê³µí–ˆì„ ë•Œ workspaceë¥¼ ë§Œë“¤ê³  ê²°ê³¼ë¬¼ì„ ë³µì‚¬í•œë‹¤, ì—†ëŠ” ê²½ìš°ì— ë¯¸ë¦¬ í´ë”ë¥¼ ë§Œë“¤ì–´ì•¼í•œë‹¤.
    - **Labels** : í˜„ì¬ ì‚¬ìš© ì¤‘ì¸ Jenkins í”„ë¡œì íŠ¸ì—ì„œ ë‹¤ë¥¸ ìª½ì˜ í”„ë¡œì íŠ¸, íŒŒì´í”„ë¼ì¸ì´ í˜„ì¬ ì¶”ê°€í•˜ëŠ” ë…¸ë“œë¥¼ ì§€ì¹­í•˜ê³ ì í•  ë•Œ ì‚¬ìš©í•˜ëŠ” ì´ë¦„
    - **Usage** : Use this node as much as possible -> Master ê°€ ì–´ë– í•œ ê·œì¹™ì— ì˜í•´ì„œ Slave ë¥¼ ì„ íƒí• ì§€ë¥¼ ê²°ì •
    - **Launch method** : master ë…¸ë“œì—ì„œ slave ë…¸ë“œë¡œ ì ‘ì†í•  ë•Œ ì–´ë–¤ ë°©ì‹ìœ¼ë¡œ ì ‘ì†í•  ì§€ì— ëŒ€í•œ ì •ë³´
        - Host : [**Slave server IP addresss**] ex) 172.17.0.5
        - Port : 22
        - Credential

<br>

### ğŸ“Node ì¶”ê°€ ê²°ê³¼
<img src="https://github.com/hyewon218/Building-CI-CD-pipelines-with-Jenkins/assets/126750615/e5f3e35f-2c19-4df4-9912-d6cf36fa3c13" width="60%"/><br>

<br>

### ğŸ“My-First-Project ìˆ˜ì •
<img src="https://github.com/hyewon218/Building-CI-CD-pipelines-with-Jenkins/assets/126750615/2814312c-f259-4310-9cd7-7b57e2d716bf" width="60%"/><br>
- Restrict where this project can be run ì„ íƒ
    - Label Expression: slave1
    - í•´ë‹¹ í”„ë¡œì íŠ¸ê°€ ì–´ë””ì—ë§Œ ë¹Œë“œ, ë°°í¬ë ì§€ë¥¼ ê²°ì •

<br>

### ğŸ“ë¹Œë“œ ê²°ê³¼
<img src="https://github.com/hyewon218/Building-CI-CD-pipelines-with-Jenkins/assets/126750615/c8fb5954-3c59-4c97-b983-94ad84178d62" width="60%"/><br>

<br>

## 8. Jenkins Slave Node ì—ì„œ ë¹Œë“œí•˜ê¸°
Pipeline í”„ë¡œì íŠ¸ë¥¼ slave ë…¸ë“œì—ì„œ ì‹¤í–‰
### Build Stage ì¶”ê°€
```
pipeline {
    agent {
			label 'slave1'
		}
    tools { 
      maven 'Maven3.9.5'
    }
    stages {
        stage('github clone') {
            steps {
                git branch: 'main', url: 'https://github.com/hyewon218/Building-CI-CD-pipelines-with-Jenkins'; 
            }
        }
        
        stage('build') {
            steps {
                sh '''
                    echo build start
                    mvn clean compile package -DskipTests=true
                '''
            }
        }
    }
}
```
- agent : slave1 Nodeì— í˜„ì¬ pipelineì„ ë¹Œë“œ
- mvn ë¹Œë“œ : targetí´ë” ë°‘ì— .warë¼ëŠ” íŒ¨í‚¤ì§• íŒŒì¼ì´ ë§Œë“¤ì–´ì§ˆ ê²ƒ
- compile : ìë°”ì—ì„œ ë§í•˜ëŠ” í´ë˜ìŠ¤ íŒŒì¼, ë°”ì´íŠ¸ ì½”ë“œë¥¼ ë§Œë“¤ì–´ ì£¼ëŠ” ì˜µì…˜

<img src="https://github.com/hyewon218/Building-CI-CD-pipelines-with-Jenkins/assets/126750615/325ea7df-a88f-4dfb-a321-f7314b4cd61a" width="60%"/><br>

<br>

### ë¹Œë“œ ê²°ê³¼
<img src="https://github.com/hyewon218/Building-CI-CD-pipelines-with-Jenkins/assets/126750615/6c0f6fc6-b6f5-4526-91ee-11f45d2c193d" width="60%"/><br>
<img src="https://github.com/hyewon218/Building-CI-CD-pipelines-with-Jenkins/assets/126750615/36fa6916-fd33-4c8e-8a52-ac21e04de94e" width="60%"/><br>

<br>

### Slave2 Node ì¶”ê°€
ì•ì—ì„œ ì§„í–‰í•œ Jenkinsì— Node ì¶”ê°€í•˜ëŠ” ì‘ì—… ì§„í–‰
```
docker run --privileged --name jenkins-node2 -itd -p 40022:22 -e container=docker -v /sys/fs/cgroup:/sys/fs/cgroup:rw --cgroupns=host  edowon0623/docker-server:m1 /usr/sbin/init
```

<br>

### Slave2 Nodeì— ë¹Œë“œ
<img src="https://github.com/hyewon218/Building-CI-CD-pipelines-with-Jenkins/assets/126750615/ec234f8f-2dd0-433b-8830-ba1b9ae644f8" width="60%"/><br>
<img src="https://github.com/hyewon218/Building-CI-CD-pipelines-with-Jenkins/assets/126750615/6b5ecd17-650f-4aa6-83a5-ed8464d06372" width="60%"/><br>

<br>

### ê²°ê³¼
```
[root@e74de17af8ff ~]# mkdir slave2
[root@e74de17af8ff ~]# cd slave2
[root@e74de17af8ff slave2]# pwd
/root/slave2
[root@e74de17af8ff slave2]# ls -al
total 1364
drwxr-xr-x 6 root root    4096 Nov 21 18:17 .
dr-xr-x--- 1 root root    4096 Nov 21 18:17 ..
drwxr-xr-x 3 root root    4096 Nov 21 18:17 caches
drwxr-xr-x 4 root root    4096 Nov 21 18:02 remoting
-rw-r--r-- 1 root root 1371113 Nov 21 18:02 remoting.jar
drwxr-xr-x 3 root root    4096 Nov 21 18:17 tools
drwxr-xr-x 4 root root    4096 Nov 21 18:17 workspace
[root@e74de17af8ff slave2]# cd workspace/
[root@e74de17af8ff workspace]# ls -al
total 16
drwxr-xr-x 4 root root 4096 Nov 21 18:17 .
drwxr-xr-x 6 root root 4096 Nov 21 18:17 ..
drwxr-xr-x 7 root root 4096 Nov 21 18:17 My-Third-Pipeline
drwxr-xr-x 2 root root 4096 Nov 21 18:17 My-Third-Pipeline@tmp
[root@e74de17af8ff workspace]# cd My-Third-Pipeline/
[root@e74de17af8ff My-Third-Pipeline]# ls -al
total 36
drwxr-xr-x 7 root root 4096 Nov 21 18:17 .
drwxr-xr-x 4 root root 4096 Nov 21 18:17 ..
drwxr-xr-x 8 root root 4096 Nov 21 18:17 .git
drwxr-xr-x 2 root root 4096 Nov 21 18:17 .idea
-rw-r--r-- 1 root root  732 Nov 21 18:17 README.md
drwxr-xr-x 2 root root 4096 Nov 21 18:17 docs
-rw-r--r-- 1 root root 3846 Nov 21 18:17 pom.xml
drwxr-xr-x 4 root root 4096 Nov 21 18:17 src
drwxr-xr-x 9 root root 4096 Nov 21 18:17 target
[root@e74de17af8ff My-Third-Pipeline]# ls ./target
classes		   generated-test-sources  hello-world.war  maven-status
generated-sources  hello-world		   maven-archiver   test-classes
```
<img src="https://github.com/hyewon218/Building-CI-CD-pipelines-with-Jenkins/assets/126750615/603855e3-2e38-4621-9c55-eef712d62c90" width="60%"/><br>