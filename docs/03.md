# Jenkins + Infrastructure as Code ì™€ì˜ ì—°ë™


## 1. Infrastructure as Code ê°œìš”ì™€ Ansibleì˜ ì´í•´
### IaC
- í”„ë¡œë¹„ì €ë‹ ë„êµ¬
- ì´ë¦„ ê·¸ëŒ€ë¡œ **ì½”ë“œì— ì˜í•´ì„œ** Infrastructure ë¥¼ ê´€ë¦¬í•œë‹¤. -> ìƒì„±, ë„¤íŠ¸ì›Œí¬ ì„¤ì •, ì‚­ì œ, ...
- ì‹œìŠ¤í…œ, í•˜ë“œì›¨ì–´ ë˜ëŠ” ì¸í„°í˜ì´ìŠ¤ì˜ êµ¬ì„±ì •ë³´ë¥¼ íŒŒì¼(**ìŠ¤í¬ë¦½íŠ¸**)ì„ í†µí•´ ê´€ë¦¬ ë° í”„ë¡œë¹„ì €ë‹
- IT ì¸í”„ë¼ìŠ¤íŠ¸ëŸ­ì²˜, ë² ì–´ ë©”íƒˆ ì„œë²„(í•˜ë“œì›¨ì–´ì— ì–´ë– í•œ ì†Œí”„íŠ¸ì›¨ì–´ë„ ì„¤ì¹˜ë˜ì–´ìˆì§€ ì•Šì€ ìˆœìˆ˜í•œ í•˜ë“œì›¨ì–´) ë“±ì˜<br> ë¬¼ë¦¬ ì¥ë¹„ ë° ê°€ìƒ ë¨¸ì‹ ê³¼ ê´€ë ¨ëœ êµ¬ì„± ë¦¬ì†ŒìŠ¤ë¥¼ ê´€ë¦¬ -> ìš´ì˜ì²´ì œ, ë„¤íŠ¸ì›Œí¬ ì„¤ì •, ë¯¸ë“¤ì›¨ì–´ì„¤ì¹˜ ê´€ë¦¬
- ë²„ì „ ê´€ë¦¬ë¥¼ í†µí•œ ë¦¬ì†ŒìŠ¤ ê´€ë¦¬
- `Ansible`, `Terraform`, `CHEF`, AWS Cloud Formation, puppet, ...
- Ansible ì€ ê¸°ì¡´ì— ì´ë¯¸ êµ¬ì„±ë˜ì–´ ìˆëŠ” ì„œë²„ë“¤ì˜ **ì •ë³´ ë³€ê²½**ì´ë‚˜ **ì„¤ì •**ë“¤ì„< ì›í•˜ëŠ” í˜•íƒœë¡œ ë°”ê¾¸ëŠ”ë° íŠ¹í™”ë˜ì–´ ìˆëŠ” IaC ë„êµ¬
- Ansibleì€ ë‹¤ë¥¸ IaC ëŒ€ë¹„í•´ì„œ ê°€ë³ê³  ë¹ ë¥´ê²Œ ì›í•˜ëŠ” ì‘ì—…ì„ í•  ìˆ˜ ìˆë‹¤ëŠ” ì¥ì ì„ ê°€ì§„ë‹¤.
- Ansibleì€ êµ¬ì„±ê´€ë¦¬ ë„êµ¬ë¼ê³  ë¶ˆë¦¬ê¸° ë•Œë¬¸ì— ì‹œìŠ¤í…œì„ êµì²´í•˜ëŠ” ì‘ì—…ë„ ê°€ëŠ¥í•˜ì§€ë§Œ ê·¸ëŸ¬í•œ ì‘ì—…ë³´ë‹¤ëŠ”<br> **ë¬¸ì œì ì„ í•´ê²°í•˜ëŠ” ìš©ë„**(ì–´ë–¤ ë¬¸ì œê°€ ë°œìƒí–ˆì„ ë•Œ ë³µêµ¬í•˜ëŠ” ë°©ë²•ì„ ìŠ¤í¬ë¦½íŠ¸ë¡œ ê¸°ë¡)ë¡œ ì‚¬ìš©í•œë‹¤.
- Ansibleì€ AWSì™€ ì—°ë™ì´ ì˜ ë˜ì–´ S3, EC2, Lamda ë“± 100ê°œ ì´ìƒì˜ ëª¨ë“ˆê³¼ ì—°ê²°ì„ í•´ì„œ<br> ì›í•˜ëŠ” êµ¬ì„± ì •ë³´ë¼ë“ ê°€ ì¸í”„ë¼ë¥¼ ê´€ë¦¬í•˜ëŠ” ìš©ë„ë¡œ ì‚¬ìš©ì´ ëœë‹¤.
- Terraform ì€ Infrastructure ë¥¼ êµ¬ì¶•í•˜ëŠ”ë° ì£¼ë¡œ ì‚¬ìš©ë˜ê³ , Ansible ì€ êµ¬ì¶•ëœ ì„œë²„ë“¤ì˜ êµ¬ì„±ì •ë³´ë¥¼ **ë³€ê²½**í•˜ê±°ë‚˜ **ê´€ë¦¬**í•˜ëŠ”ë° ì£¼ë¡œ ì‚¬ìš©ëœë‹¤.

<br>

### Before & After Configure management
#### Before
êµ¬ì„±ì •ë³´ íŒŒì¼ì„ ë‹¤ë£¨ëŠ”ë° ìˆì–´ì„œ IaCë¥¼ ì‚¬ìš©í•˜ì§€ ì•Šì•˜ì„ ë•Œ<br>
<img src="https://github.com/hyewon218/Building-CI-CD-pipelines-with-Jenkins/assets/126750615/a1691fc4-79d5-4080-b8e0-ea9b02ac589f" width="60%"/><br>
- ì„œë²„ê°€ 4ëŒ€ê°€ ì¡´ì¬í•˜ê³ , ë‹¤ì–‘í•œ í˜•íƒœì˜ ë””ë°”ì´ìŠ¤ë¥¼ í†µí•´ ì„œë²„ë¥¼ ê´€ë¦¬
- íŠ¹ì • ì„œë²„ì— ì˜¤ë¥˜ê°€ ìƒê²¨ì„œ ê´€ë¦¬ìê°€ ì•Œê²Œë˜ë©´ ì˜¤ë¥˜ ìƒê¸´ ì„œë²„ë¥¼ ì§€ìš°ê³  í•„ìš”í•œ ì„œë²„ë¥¼ ì¦ì„¤í•˜ì—¬ ì •ìƒì ì¸ ì„œë¹„ìŠ¤ë¥¼ ì§€ì›

<br>

#### After
ìœ„ ì‘ì—…ì„ í•˜ëŠ”ë° ìˆì–´ì„œ IaCë¥¼ ì‚¬ìš©í–ˆì„ ë•Œ<br>
<img src="https://github.com/hyewon218/Building-CI-CD-pipelines-with-Jenkins/assets/126750615/f7b8558f-e0f8-46e7-8fe2-f5da5a1525d1" width="60%"/><br>
- Ansibleì— ì„œë²„ë“¤ì„ ê´€ë¦¬í•˜ë„ë¡ ì§€ì • -> inventory
- ì„œë²„ë¥¼ ê´€ë¦¬í•¨ì— ìˆì–´ì„œ ì„œë²„ì˜ ëª©ë¡ì´ë‚˜ ì‘ì—… ì ˆì°¨ë¥¼ ë‹´ì•„ë‘” ìŠ¤í¬ë¦½íŠ¸ íŒŒì¼ì„ ì§€ì • -> Play Books

<br>

<img src="https://github.com/hyewon218/Building-CI-CD-pipelines-with-Jenkins/assets/126750615/a3edea21-89de-45fc-9241-9a9b32bbd411" width="60%"/><br>
- ì„œë²„ í•œëŒ€ê°€ ë¬¸ì œê°€ ìƒê¸´ë‹¤ë©´ Play Booksì— ê¸°ë¡ëœ ì •ë³´ì— ì˜í•´ì„œ ìë™ìœ¼ë¡œ ìƒˆë¡œìš´ ì„œë²„ë¥¼ ì¶”ê°€í•˜ëŠ” ì‘ì—…ì„ í†µí•´ ì •ìƒì ì¸ ì„œë¹„ìŠ¤ë¥¼ ì§€ì›
- ì´ì™€ ê°™ì´ ê´€ë¦¬ìê°€ ì§ì ‘í•´ì•¼í•˜ëŠ” ì¸í”„ë¼ì˜ ì œì–´ë‚˜ ê´€ë¦¬ë¥¼ Ansible, Terraform ê³¼ ê°™ì€ IaC ë„êµ¬ë¥¼ í†µí•´ ëŒ€ì‹  ê´€ë¦¬ ê°€ëŠ¥
- ì´ì™€ ê°™ì´ ìƒˆë¡­ê²Œ ì¶”ê°€ëœ ì„œë²„ëŠ” Ansibleì„ í†µí•´ì„œ ì§€ì†ì ìœ¼ë¡œ ìƒíƒœë¥¼ ìœ ì§€í•  ìˆ˜ ìˆë„ë¡ ì§€ì›í•´ì¤€ë‹¤.

<br>

### Configuration Management Tools
<img src="https://github.com/hyewon218/Building-CI-CD-pipelines-with-Jenkins/assets/126750615/8fa65733-7980-4dee-844f-479f52bb3b17" width="60%"/><br>
- Ansibleì˜ ê°€ì¥ í° í•µì‹¬ì€ Agentê°€ ë¶ˆí•„ìš”í•˜ë‹¤ëŠ” ë¶€ë¶„
- ëŒ€ë¶€ë¶„ ë©”ì¸ ì„œë²„(Ansible ì„œë²„)ê°€ ìš´ì˜ ì„œë²„(í´ë¼ì´ì–¸íŠ¸)ë¥¼ ê´€ë¦¬í•˜ëŠ”ë° ìˆì–´ì„œ ìš´ì˜ ì„œë²„(í´ë¼ì´ì–¸íŠ¸)ë“¤ì€ ë©”ì¸ ì„œë²„(Ansible ì„œë²„)ë¡œ ë¶€í„° ì •ë³´ë¥¼ ì „ë‹¬ ë°›ê¸° ìœ„í•œ Agent(í´ë¼ì´ì–¸íŠ¸) ë“¤ì´ í•„ìš”í•œ ë¶€ë¶„ì´ ëŒ€ë¶€ë¶„ì´ê³  ì´ëŸ¬í•œ Agent(í´ë¼ì´ì–¸íŠ¸)ì™€ ë©”ì¸ ì„œë²„(Ansible ì„œë²„) ì‚¬ì´ì˜ í”„ë¡œí† ì½œ í†µí•´ í†µì‹ ì„ í•´ì„œ ì‘ì—…ì„ ì£¼ê³  ë°›ëŠ”ë‹¤.
- Ansible ì„ ì‚¬ìš©í•˜ë©´ ìš´ì˜ ì„œë²„(í´ë¼ì´ì–¸íŠ¸) ì´ëŸ¬í•œ Agent ê°€ í•„ìš”ì—†ë‹¤.
- ì´ìœ ëŠ” ê°ê°ì˜ ì„œë²„ì— Python ì–¸ì–´ê°€ ì„¤ì¹˜ë˜ì–´ ìˆë‹¤ë©´ Pythonì´ ê°€ì§„ ë„¤íŠ¸ì›Œí¬ ëª¨ë“ˆì„ í†µí•´ì„œ ì„œë²„ì™€ í†µì‹ í•˜ê¸° ë•Œë¬¸ì´ë‹¤. -> ë¦¬ëˆ…ìŠ¤ ì‹œìŠ¤í…œì€ ê¸°ë³¸ì ìœ¼ë¡œ Pythonì´ ì„¤ì¹˜ë˜ì–´ ìˆë‹¤.

<br>

### Ansible
<img src="https://github.com/hyewon218/Building-CI-CD-pipelines-with-Jenkins/assets/126750615/d95c9629-6f0e-4c41-9299-ce026245d91a" width="60%"/><br>
- ì—¬ëŸ¬ ê°œì˜ ì„œë²„ë¥¼ íš¨ìœ¨ì ìœ¼ë¡œ ê´€ë¦¬í•  ìˆ˜ ìˆê²Œ í•´ì£¼ëŠ” í™˜ê²½ êµ¬ì„± **ìë™í™”** ë„êµ¬
    - Configuration Management, Deployment & Orchestration tool
    - IT infrastructure **ìë™í™”**
- **Push** ê¸°ë°˜ ì„œë¹„ìŠ¤
- Simple, **Agentless**(ë³„ë„ë¡œ ê´€ë¦¬í•˜ê³ ìí•˜ëŠ” ëŒ€ìƒ ì„œë²„ì— ì¶”ê°€ë¡œ ì„¤ì¹˜í•  ë‚´ìš©ì´ í¬í•¨ë˜ì–´ìˆì§€ ì•Šë‹¤.)
- í•  ìˆ˜ ìˆëŠ”ì¼<br>
  <img src="https://github.com/hyewon218/Building-CI-CD-pipelines-with-Jenkins/assets/126750615/b9bdbd8b-1933-4190-989b-dafa4538098d" width="60%"/><br>
    - ì„¤ì¹˜: apt-get, yum, homebrew
    - íŒŒì¼ ë° ìŠ¤í¬ë¦½íŠ¸ ë°°í¬: copy
    - ë‹¤ìš´ë¡œë“œ: get_url, git
    - ì‹¤í–‰: shell, task
    - ì¦‰, Ansible ì„œë²„ì—ì„œ ëŒ€ìƒ ì„œë²„ê°€ ë˜ëŠ” ê³³ì— í”„ë¡œê·¸ë¨ì„  ì„¤ì¹˜, íŒŒì¼ ë° ìŠ¤í¬ë¦½íŠ¸ ë°°í¬, ë‹¤ìš´ë¡œë“œ, ì‹¤í–‰ì´ ê°€ëŠ¥í•˜ë‹¤.
- ê²°ê³¼
    - `ok` / `failed` / `changed` / `unreachable`
- êµ¬ì„±ë„ ì˜ˆì‹œ<br>
  <img src="https://github.com/hyewon218/Building-CI-CD-pipelines-with-Jenkins/assets/126750615/f4098c90-854c-474e-b948-17b88d0f1e70" width="60%"/><br>

### Install Ansible
- Ansible Server ì„¤ì¹˜ (Linux)
  - `yum install ansible`
  - `ansible --version`
- í™˜ê²½ ì„¤ì • íŒŒì¼ ->Â `/etc/ansible/ansible.cfg`
- Ansible ì—ì„œ ì ‘ì†í•˜ëŠ” í˜¸ìŠ¤íŠ¸ ëª©ë¡ ->Â `/etc/ansible/hosts`
  - nginx ë¼ëŠ” ê·¸ë£¹ì˜ ëª©ë¡ë“¤<br>
    <img src="https://github.com/hyewon218/Building-CI-CD-pipelines-with-Jenkins/assets/126750615/18d42c40-48b5-4133-89b4-7b11094756a0" width="30%"/><br>

<br>

## 2. Docker ì»¨í…Œì´ë„ˆë¡œ Ansible ì‹¤í–‰í•˜ê¸°
### Create a docker instance for Ansible
- Ansibleì„ ê°€ì§€ê³  ìˆëŠ” ë„ì»¤ ì´ë¯¸ì§€ -> edowon0623/ansible
  ```
  docker pull edowon0623/ansible-server:m1
  ```
  ```
  choihyewon@choehyewon-ui-noteubug ~ % docker pull edowon0623/ansible-server:m1
  m1: Pulling from edowon0623/ansible-server
  52f9ef134af7: Already exists
  b0057b9a5ec7: Already exists
  5de1b09ce5f0: Already exists
  220446312972: Already exists
  3315db72bb66: Already exists
  d7b146b2846c: Already exists
  6ad839f282f8: Already exists
  9a32b78ae1f2: Already exists
  d27b78b9e37a: Already exists
  057d0583946b: Already exists
  92b30088b9f6: Already exists
  de85a0cecf04: Already exists
  2722065ffa48: Already exists
  be62d423d9d9: Pull complete
  b961e375c3bf: Pull complete
  318fa5a009d7: Pull complete
  a3ed95caeb02: Pull complete
  cf7db50c8c20: Pull complete
  Digest: sha256:84fbc1d619401f50dd5327f20d996b6cba5a9bfe00da7079b79572828fd5173f
  Status: Downloaded newer image for edowon0623/ansible-server:m1
  docker.io/edowon0623/ansible-server:m1

  What's Next?
  View summary of image vulnerabilities and recommendations â†’ docker scout quickview edowon0623/ansible-server:m1
  ```
  <img src="https://github.com/hyewon218/Building-CI-CD-pipelines-with-Jenkins/assets/126750615/58a5c7e3-25d5-4301-bfe6-33e373b85bdd" width="60%"/><br>

<br>

### Run Ansible Server
#### ğŸ“ì‹¤í–‰
```
docker run --privileged --name ansible-server -itd -p 20022:22 -p 8082:8080 -e container=docker -v /sys/fs/cgroup:/sys/fs/cgroup --cgroupns=host edowon0623/ansible-server:m1 /usr/sbin/init
```
- --privileged: ê´€ë¦¬ì ê¶Œí•œì„ ê°€ì§€ê³  ì‹¤í–‰
<br>

<img src="https://github.com/hyewon218/Building-CI-CD-pipelines-with-Jenkins/assets/126750615/935e258c-c803-4333-a632-09a39fdf31a8" width="60%"/><br>

<br>

#### ğŸ“Docker network ìƒì„¸ë³´ê¸°
```
docker network inspect bridge
```
```
 ~ % docker network inspect bridge
[
    {
        "Name": "bridge",
        "Id": "ca762f1e65e3ae81dc07dbfe96282f93a17a420487ef05a598f7688df4b5c9fd",
        "Created": "2023-11-09T00:45:38.966240333Z",
        "Scope": "local",
        "Driver": "bridge",
        "EnableIPv6": false,
        "IPAM": {
            "Driver": "default",
            "Options": null,
            "Config": [
                {
                    "Subnet": "172.17.0.0/16",
                    "Gateway": "172.17.0.1"
                }
            ]
        },
        "Internal": false,
        "Attachable": false,
        "Ingress": false,
        "ConfigFrom": {
            "Network": ""
        },
        "ConfigOnly": false,
        "Containers": {
            "67df6243d6351c58a100eda103e4efe8fa2a868fbc5c7a556281ff6cb9c75811": {
                "Name": "jenkins-server",
                "EndpointID": "d21d6e693f64da022c3e512b43c5add10cc60e088e9d2a6b28c32a0ded62baa5",
                "MacAddress": "02:42:ac:11:00:03",
                "IPv4Address": "172.17.0.3/16",
                "IPv6Address": ""
            },
            "b2b74aa4e31b70897cb042cb12a4e7efac91c495703509034494587d11f7f093": {
                "Name": "ansible-server",
                "EndpointID": "94963be69cefdd9078a1eeebe4b7038334d57419f00f5e0fec0ea7b820b4cf8a",
                "MacAddress": "02:42:ac:11:00:04",
                "IPv4Address": "172.17.0.4/16",
                "IPv6Address": ""
            },
            "c6caaa1f3878f770c3028da8883e0331d090901301ff59a6d85fd5fe4480cb6d": {
                "Name": "docker-server",
                "EndpointID": "f94eddc2a15d4097fd89e90c7386d75ea1672593a0e9dbaa0323c3cf937ff4f1",
                "MacAddress": "02:42:ac:11:00:02",
                "IPv4Address": "172.17.0.2/16",
                "IPv6Address": ""
            }
        },
        "Options": {
            "com.docker.network.bridge.default_bridge": "true",
            "com.docker.network.bridge.enable_icc": "true",
            "com.docker.network.bridge.enable_ip_masquerade": "true",
            "com.docker.network.bridge.host_binding_ipv4": "0.0.0.0",
            "com.docker.network.bridge.name": "docker0",
            "com.docker.network.driver.mtu": "65535"
        },
        "Labels": {}
    }
]
```
<img src="https://github.com/hyewon218/Building-CI-CD-pipelines-with-Jenkins/assets/126750615/e8b17d3d-62af-4625-b3e1-5b34f8b4ebf0" width="60%"/><br>

- ì»¨í…Œì´ë„ˆì—ì„œ ì‹¤í–‰)
  - `$ systemctl start docker`
  - `$ systemctl status docker`

<br>

#### ğŸ“SSH ì ‘ì†
```
ssh root@localhost -p 20022
```
<br>

#### ğŸ“ansible ë²„ì „ í™•ì¸
```
ansible --version
```
```
[root@b2b74aa4e31b ~]# ansible --version
ansible [core 2.13.2]
  config file = None
  configured module search path = ['/root/.ansible/plugins/modules', '/usr/share/ansible/plugins/modules']
  ansible python module location = /usr/local/lib/python3.8/site-packages/ansible
  ansible collection location = /root/.ansible/collections:/usr/share/ansible/collections
  executable location = /usr/local/bin/ansible
  python version = 3.8.8 (default, Aug 25 2021, 16:18:04) [GCC 8.5.0 20210514 (Red Hat 8.5.0-3)]
  jinja version = 3.1.2
  libyaml = True
```

<br>

#### ğŸ“inventory
```
vi /etc/ansible/hosts
```
- ansibledì˜ í´ë¼ì´ì–¸íŠ¸ë“¤ì— ëŒ€í•œ ì •ë³´ ë“±ë¡

```
[devops](ê·¸ë£¹ëª…)
172.17.0.2 (docker)
172.17.0.4 (ansible)
```
- ì„ì‹œë¡œ ë“±ë¡í•´ ë†“ì€ ì •ë³´ì´ê¸° ë•Œë¬¸ì— í™˜ê²½ì— ë§ì¶° ìˆ˜ì •í•´ì•¼ í•¨
- ë¸Œë¦¿ì§€ ë„¤íŠ¸ì›Œí¬ì— ë“±ë¡ë˜ì–´ì§„ ì»¨í…Œì´ë„ˆì˜ ëª©ë¡ì„ ë³¼ ìˆ˜ ìˆë‹¤.<br>
  <img src="https://github.com/hyewon218/Building-CI-CD-pipelines-with-Jenkins/assets/126750615/2bff9085-0864-4a8b-a008-fabb19f187ab" width="60%"/><br>

<br>

#### ğŸ“ í‚¤ ìƒì„±) ssh-keygen
> Ansible ì„œë²„ì—ì„œ ë“±ë¡í•œ ëŒ€ìƒ ì„œë²„ë“¤ë¡œ SSHë¥¼ í†µí•´ ì ‘ì†í•˜ëŠ” ë° ìˆì–´ì„œ id â€¢ passwordë¥¼ í†µí•´ ì ‘ì†í•˜ëŠ”ë°, <br>
> Ansibleì„ í†µí•´ì„œ ì‹¤í–‰í•˜ë ¤ëŠ” ì»¤ë§¨ë“œì— ì ‘ì†í•  ë•Œ ë§¤ë²ˆ idì™€ passwordë¥¼ ì…ë ¥í•˜ê¸° ë²ˆê±°ë¡­ê¸° ë•Œë¬¸ì— <br>
> Ansible ì„œë²„ì— ì¡´ì¬í•˜ëŠ” í‚¤ê°’ì„ ê°€ì§€ê³  ëŒ€ìƒ ì„œë²„ì— ë°°í¬í•¨ìœ¼ë¡œì¨ id â€¢ password ì—†ì´ ì ‘ì†í•˜ê²Œ í•œë‹¤.<br>

```
ssh-keygen
```
- /root/.ssh/id_rsa (id_rsa: í¼ë¸”ë¦­, í”„ë¼ì´ë¹— í‚¤) ìƒì„±

```
[root@b2b74aa4e31b ~]# ssh-keygen
Generating public/private rsa key pair.
Enter file in which to save the key (/root/.ssh/id_rsa): 
Created directory '/root/.ssh'.
Enter passphrase (empty for no passphrase): 
Enter same passphrase again: 
Your identification has been saved in /root/.ssh/id_rsa.
Your public key has been saved in /root/.ssh/id_rsa.pub.
The key fingerprint is:

The key's randomart image is:

```
<img src="https://github.com/hyewon218/Building-CI-CD-pipelines-with-Jenkins/assets/126750615/3e411801-caf0-4abf-8887-d4e73c91750a" width="60%"/><br>


<br>

#### ğŸ“í‚¤ ë³µì‚¬) ssh-copy-id root@[ì ‘ì†í•  ì„œë²„ IP]
```
ssh-copy-id root@172.17.0.3
```
- í‚¤ ê°’ì„ (ê°ê° ì„œë²„ì—)**ë°°í¬**í•˜ì—¬ ì ‘ì†ì‹œ ì•„ì´ë””, ë¹„ë°€ë²ˆí˜¸ ìƒëµ ê°€ëŠ¥
- ì´ ë°°í¬ ì‘ì—…ì„ í•´ì•¼ ì´í›„ì— ëª¨ë“  í…ŒìŠ¤íŠ¸ ì‘ì—…ì„ í•¨ì— ìˆì–´ ë³„ë„ë¡œ íŒ¨ìŠ¤ì›Œë“œ ì…ë ¥í•˜ì§€ ì•Šì€ ìƒíƒœë¡œ ì‘ì—…í•  ìˆ˜ ìˆê²Œ ëœë‹¤.

<br>

## 3. Ansible ì„¤ì •ê³¼ ì‘ë™ ê³¼ì •

- docker-server: 172.17.0.2
- ansible-server: 172.17.0.4

### inventory ìƒì„±
```
mkdir /etc/ansible
vi /etc/ansible/hosts
```

<br>

### /etc/ansible/hosts
```
[devops]
172.17.0.2
172.17.0.4
```
- docker-server í´ë¼ì´ì–¸íŠ¸ë¡œ ê´€ë¦¬
- ansible-server ìê¸° ìì‹ ë„ í´ë¼ì´ì–¸íŠ¸ë¡œ ê´€ë¦¬(localhost)

### í˜„ì¬ìƒí™© (java ì œì™¸)
<img src="https://github.com/hyewon218/Building-CI-CD-pipelines-with-Jenkins/assets/126750615/ef079de5-9d79-4d91-9507-59f84d3e7a93" width="60%"/><br>
<br>
<img src="https://github.com/hyewon218/Building-CI-CD-pipelines-with-Jenkins/assets/126750615/64508387-a33b-42f4-9289-a4ae93c9f5fc" width="60%"/><br>
- Ansible ì„œë²„ ì•ˆì—ì„œ ë‹¤ë¥¸ ì„œë²„ë¡œ ì ‘ì†í•  ë•ŒëŠ” í¬íŠ¸í¬ì›Œë”© X<br>

<img src="https://github.com/hyewon218/Building-CI-CD-pipelines-with-Jenkins/assets/126750615/efbd0011-dd16-4eea-b2b2-718f8eee609e" width="60%"/><br>

<br>

```
[root@b2b74aa4e31b ~]# ssh root@172.17.0.2 - b2b74aa4e31b (host ì»¨í…Œì´ë„ˆ id)
The authenticity of host '172.17.0.2 (172.17.0.2)' can't be established.
ECDSA key fingerprint is SHA256:rbybV2UK8eDvAGhSTNuhNkez9rYPTrPCCR4NpSVV+xc.
Are you sure you want to continue connecting (yes/no/[fingerprint])? yes
Warning: Permanently added '172.17.0.2' (ECDSA) to the list of known hosts.
root@172.17.0.2's password: 
Last login: Wed Nov  8 06:34:11 2023 from 172.17.0.1
[root@c6caaa1f3878 ~]# - c6caaa1f3878 (docker ì»¨í…Œì´ë„ˆ id)

[root@c6caaa1f3878 ~]# exit
logout
Connection to 172.17.0.2 closed.
[root@b2b74aa4e31b ~]# ssh-copy-id root@172.17.0.2
/usr/bin/ssh-copy-id: INFO: Source of key(s) to be installed: "/root/.ssh/id_rsa.pub"
/usr/bin/ssh-copy-id: INFO: attempting to log in with the new key(s), to filter out any that are already installed
/usr/bin/ssh-copy-id: INFO: 1 key(s) remain to be installed -- if you are prompted now it is to install the new keys
root@172.17.0.2's password: (ì²˜ìŒ í•œ ë²ˆ ì…ë ¥í•´ì£¼ë©´!)

Number of key(s) added: 1

Now try logging into the machine, with:   "ssh 'root@172.17.0.2'"
and check to make sure that only the key(s) you wanted were added.

[root@b2b74aa4e31b ~]# ssh root@172.17.0.2 (ë‹¤ì‹œ ì ‘ì†í•˜ë©´ ë¡œê·¸ì¸ ì—†ì´ ì ‘ì†ë¨)
Last login: Thu Nov  9 07:59:53 2023 from 172.17.0.4
```
```
[root@c6caaa1f3878 ~]# exit
logout
Connection to 172.17.0.2 closed.
[root@b2b74aa4e31b ~]# ssh root@172.17.0.4 (ìê¸° ìì‹  ì ‘ì†)
The authenticity of host '172.17.0.4 (172.17.0.4)' can't be established.
ECDSA key fingerprint is SHA256:L+KnXcoaiu8SkOYLNCVPMAj3+1v8aIbaZMmB+Du67GE.
Are you sure you want to continue connecting (yes/no/[fingerprint])? yes
Warning: Permanently added '172.17.0.4' (ECDSA) to the list of known hosts.
root@172.17.0.4's password: 
Last login: Thu Nov  9 05:52:41 2023 from 172.17.0.1
[root@b2b74aa4e31b ~]# exit
logout
Connection to 172.17.0.4 closed.
[root@b2b74aa4e31b ~]# ssh root@172.17.0.4
root@172.17.0.4's password: 
Last login: Thu Nov  9 09:08:38 2023 from 172.17.0.4
[root@b2b74aa4e31b ~]# exit
logout
Connection to 172.17.0.4 closed.
[root@b2b74aa4e31b ~]# ssh-copy-id root@172.17.0.4
/usr/bin/ssh-copy-id: INFO: Source of key(s) to be installed: "/root/.ssh/id_rsa.pub"
/usr/bin/ssh-copy-id: INFO: attempting to log in with the new key(s), to filter out any that are already installed
/usr/bin/ssh-copy-id: INFO: 1 key(s) remain to be installed -- if you are prompted now it is to install the new keys
root@172.17.0.4's password: 

Number of key(s) added: 1

Now try logging into the machine, with:   "ssh 'root@172.17.0.4'"
and check to make sure that only the key(s) you wanted were added.

[root@b2b74aa4e31b ~]# ssh root@172.17.0.4
Last login: Thu Nov  9 09:09:26 2023 from 172.17.0.4
```
<br>

## 4. Ansible ê¸°ë³¸ ëª…ë ¹ì–´
### Test Ansible module

### ì‹¤í–‰ ì˜µì…˜

- i(--inventory-file)
  - ì ìš© ë  í˜¸ìŠ¤íŠ¸ë“¤ì— ëŒ€í•œ íŒŒì¼ ì •ë³´
  - ì ìš©ë˜ê³ ì í•˜ëŠ” Ansible í´ë¼ì´ì–¸íŠ¸ë“¤ì— ëŒ€í•œ ì •ë³´ë¥¼ ì§€ì •í•  ìˆ˜ ìˆë‹¤.
  - i ì˜µì…˜ì´ ì—†ì„ ê²½ìš°ì—ëŠ”`etc/ansible/hosts`ë‚´ìš©ì„ ì‚¬ìš©
- m
  - ëª¨ë“ˆ ì„ íƒ
- k
  - ê´€ë¦¬ì ì•”í˜¸ ìš”ì²­
  - ssh-copy-idë¥¼ í†µí•´ ì´ë¯¸ ì²˜ë¦¬ -> ì•”í˜¸ í•„ìš” X
- K
  - ê´€ë¦¬ì ê¶Œí•œ ìƒìŠ¹
- -list-hosts
  - ì ìš©ë˜ëŠ” í˜¸ìŠ¤íŠ¸ ëª©ë¡


### â­ï¸ **ë©±ë“±ì„±**

- ê°™ì€ ì„¤ì •ì„ ì—¬ëŸ¬ ë²ˆ ì ìš©í•˜ë”ë¼ë„ ê²°ê³¼ê°€ ë‹¬ë¼ì§€ì§€ ì•ŠëŠ” ì„±ì§ˆ(í•œ ë²ˆë§Œ ì ìš© ë¨)
  - ex) echo -e "[mygroup]\n172.20.10.11" >> /etc/ansible/hosts
  - ì˜ˆë¥¼ ë“¤ì–´ echo ì»¤ë§¨ë“œë¥¼ ì´ìš©í•´ì„œ ë¬¸ìì—´ì„ í•´ë‹¹ íŒŒì¼ì— ì €ì¥í•œë‹¤ê³  í•˜ë©´ Ansible ë¥¼ í†µí•´ì„œ ì‹¤í–‰í•˜ë©´ í•œ ë²ˆë§Œ ë™ì‘í•œë‹¤.
  - ansibleì„ ì‚¬ìš©í•˜ê²Œ ë˜ë©´ ìˆœì°¨ì ìœ¼ë¡œ ì‘ì—…í–ˆë˜ ê²ƒì„ ansibleì—ì„œ ë™ì¼í•˜ê²Œ í•œ ë²ˆë§Œ ì‹¤í–‰í•´ ì£¼ê²Œ ë˜ë©´ ë“±ë¡ë˜ì–´ì§„ ëª¨ë“  íƒ€ê²Ÿ ì„œë²„ì— ë‹¤ ëª…ë ¹ì–´ê°€ ì‹¤í–‰ëœë‹¤, ì¦‰ ì œì–´í•  ìˆ˜ ìˆë‹¤.

<br>

### ë©±ë“±ì„±X
```
[root@b2b74aa4e31b ~]# cat /etc/ansible/hosts
[devops]
172.17.0.2
172.17.0.4
[root@b2b74aa4e31b ~]# echo -e "[mygroup]\n172.17.0.5" >> /etc/ansible/hosts
[root@b2b74aa4e31b ~]# cat /etc/ansible/hosts
[devops]
172.17.0.2
172.17.0.4
[mygroup]
172.17.0.5
[root@b2b74aa4e31b ~]# echo -e "[mygroup]\n172.17.0.5" >> /etc/ansible/hosts
[root@b2b74aa4e31b ~]# cat /etc/ansible/hosts
[devops]
172.17.0.2
172.17.0.4
[mygroup]
172.17.0.5
[mygroup]
172.17.0.5 (ê³„ì† ì¶”ê°€ë¨)
```

<br>

## 5. Ansible ë¬˜ë“ˆ ì‚¬ìš©
### Ansible Test
```
ansible all -m ping
ansible devops -m ping
```
- all : ansibleì— ì ìš© ì‹œí‚¤ê³ ìí•˜ëŠ” ê·¸ë£¹ì˜ ì´ë¦„
  - allì˜ ê²½ìš°ì— ëª¨ë“  ê·¸ë£¹
- m
  - ëª¨ë“ˆì„ íƒ
  - ping: ëª¨ë“ˆ ì´ë¦„<br>
    <img src="https://github.com/hyewon218/Building-CI-CD-pipelines-with-Jenkins/assets/126750615/2450188f-93fc-40a9-92c9-deb8dfe9f307" width="60%"/><br>

<br>

### ê²°ê³¼
```
[root@b2b74aa4e31b ~]# ansible devops -m ping
172.17.0.4 | SUCCESS => {
    "ansible_facts": {
        "discovered_interpreter_python": "/usr/libexec/platform-python"
    },
    "changed": false,
    "ping": "pong"
}
172.17.0.2 |  => {
    "ansible_facts": {
        "discovered_interpreter_python": "/usr/libexec/platform-python"
    },
    "changed": false,
    "ping": "pong"
}
```
<br>

### Disk ìš©ëŸ‰ í™•ì¸
```
ansible devops -m shell -a "free -h"
```
```
[root@b2b74aa4e31b ~]# ansible devops -m shell -a "free -h"
172.17.0.4 | CHANGED | rc=0 >>
              total        used        free      shared  buff/cache   available
Mem:          7.7Gi       1.3Gi       2.5Gi       321Mi       3.9Gi       5.9Gi
Swap:         1.0Gi          0B       1.0Gi
172.17.0.2 | CHANGED | rc=0 >>
              total        used        free      shared  buff/cache   available
Mem:          7.7Gi       1.3Gi       2.5Gi       321Mi       3.9Gi       5.9Gi
Swap:         1.0Gi          0B       1.0Gi
```
- devops ê·¸ë£¹ì— shell ëª…ë ¹ì–´ë¥¼ í†µí•´ free -h ì „ë‹¬

<br>

### íŒŒì¼ ì „ì†¡
```
ansible devops -m copy -a "src=./test.txt dest=/tmp"
```
```
[root@b2b74aa4e31b ~]# touch test.txt
[root@b2b74aa4e31b ~]# ls -al
total 60
dr-xr-x--- 1 root root 4096 Nov  9 16:47 .
drwxr-xr-x 1 root root 4096 Nov  9 06:50 ..
drwxr-xr-x 4 root root 4096 Nov  9 15:58 .ansible
-rw------- 1 root root  182 Nov  9 09:08 .bash_history
-rw-r--r-- 1 root root   18 May 11  2019 .bash_logout
-rw-r--r-- 1 root root  176 May 11  2019 .bash_profile
-rw-r--r-- 1 root root  176 May 11  2019 .bashrc
drwxr-xr-x 1 root root 4096 Jul 31  2022 .cache
-rw-r--r-- 1 root root  100 May 11  2019 .cshrc
drwx------ 2 root root 4096 Nov  9 09:09 .ssh
-rw-r--r-- 1 root root  129 May 11  2019 .tcshrc
-rw-r--r-- 1 root root  129 Jul 31  2022 Dockerfile
-rw------- 1 root root 2365 Sep 15  2021 anaconda-ks.cfg
-rw-r--r-- 1 root root  608 Sep 15  2021 anaconda-post.log
-rw------- 1 root root 2062 Sep 15  2021 original-ks.cfg
-rw-r--r-- 1 root root    0 Nov  9 16:47 test.txt
[root@b2b74aa4e31b ~]# echo "Hi, there!" >> test.txt
[root@b2b74aa4e31b ~]# cat test.txt
Hi, there!
```

<br>

```
[root@b2b74aa4e31b ~]# hostname -i
172.17.0.4
[root@b2b74aa4e31b ~]# ls -al /tmp
total 40
drwxrwxrwt 1 root root 4096 Nov  9 17:07 .
drwxr-xr-x 1 root root 4096 Nov  9 06:50 ..
drwxrwxrwt 2 root root 4096 Sep 15  2021 .ICE-unix
drwxrwxrwt 2 root root 4096 Sep 15  2021 .Test-unix
drwxrwxrwt 2 root root 4096 Sep 15  2021 .X11-unix
drwxrwxrwt 2 root root 4096 Sep 15  2021 .XIM-unix
drwxrwxrwt 2 root root 4096 Sep 15  2021 .font-unix
-rwx------ 1 root root  671 Sep 15  2021 ks-script-bpiwbjzf
-rwx------ 1 root root  291 Sep 15  2021 ks-script-brc9ul2l
-rwx------ 1 root root  701 Sep 15  2021 ks-script-sgnfirn_
[root@b2b74aa4e31b ~]# pwd
/root
[root@b2b74aa4e31b ~]# ls -al test.txt
-rw-r--r-- 1 root root 11 Nov  9 16:48 test.txt
[root@b2b74aa4e31b ~]# ansible devops -m copy -a "src=./test.txt dest=/tmp"
172.17.0.4 | CHANGED => {
    "ansible_facts": {
        "discovered_interpreter_python": "/usr/libexec/platform-python"
    },
    "changed": true,
    "checksum": "35bb56ee38c018cdb0f26ad49c7a69f4ee147d2b",
    "dest": "/tmp/test.txt",
    "gid": 0,
    "group": "root",
    "md5sum": "789716db4f40a28d97c707fee16ad524",
    "mode": "0644",
    "owner": "root",
    "size": 11,
    "src": "/root/.ansible/tmp/ansible-tmp-1699584654.3450816-876-20685241292895/source",
    "state": "file",
    "uid": 0
}
172.17.0.2 | CHANGED => {
    "ansible_facts": {
        "discovered_interpreter_python": "/usr/libexec/platform-python"
    },
    "changed": true,
    "checksum": "35bb56ee38c018cdb0f26ad49c7a69f4ee147d2b",
    "dest": "/tmp/test.txt",
    "gid": 0,
    "group": "root",
    "md5sum": "789716db4f40a28d97c707fee16ad524",
    "mode": "0644",
    "owner": "root",
    "size": 11,
    "src": "/root/.ansible/tmp/ansible-tmp-1699584654.344981-874-120060085777745/source",
    "state": "file",
    "uid": 0
}
```
<br>

### í”„ë¡œê·¸ë¨ ì„¤ì¹˜
```
ansible devops -m yum -a "name=httpd state=present"
```
```
[root@b2b74aa4e31b ~]# ansible devops -m yum -a "name=httpd state=present"
172.17.0.2 | CHANGED => {
    "ansible_facts": {
        "discovered_interpreter_python": "/usr/libexec/platform-python"
    },
    "changed": true,
    "msg": "",
    "rc": 0,
    "results": [
        "Installed: apr-util-openssl-1.6.1-6.el8.aarch64",
        "Installed: brotli-1.0.6-3.el8.aarch64",
        "Installed: mod_http2-1.15.7-3.module_el8.4.0+778+c970deab.aarch64",
        "Installed: centos-logos-httpd-85.8-2.el8.noarch",
        "Installed: mailcap-2.1.48-3.el8.noarch",
        "Installed: httpd-2.4.37-43.module_el8.5.0+1022+b541f3b1.aarch64",
        "Installed: apr-1.6.3-12.el8.aarch64",
        "Installed: httpd-filesystem-2.4.37-43.module_el8.5.0+1022+b541f3b1.noarch",
        "Installed: apr-util-1.6.1-6.el8.aarch64",
        "Installed: apr-util-bdb-1.6.1-6.el8.aarch64",
        "Installed: httpd-tools-2.4.37-43.module_el8.5.0+1022+b541f3b1.aarch64"
    ]
}
172.17.0.4 | CHANGED => {
    "ansible_facts": {
        "discovered_interpreter_python": "/usr/libexec/platform-python"
    },
    "changed": true,
    "msg": "",
    "rc": 0,
    "results": [
        "Installed: apr-1.6.3-12.el8.aarch64",
        "Installed: httpd-filesystem-2.4.37-43.module_el8.5.0+1022+b541f3b1.noarch",
        "Installed: apr-util-1.6.1-6.el8.aarch64",
        "Installed: apr-util-bdb-1.6.1-6.el8.aarch64",
        "Installed: centos-logos-httpd-85.8-2.el8.noarch",
        "Installed: httpd-tools-2.4.37-43.module_el8.5.0+1022+b541f3b1.aarch64",
        "Installed: apr-util-openssl-1.6.1-6.el8.aarch64",
        "Installed: brotli-1.0.6-3.el8.aarch64",
        "Installed: mod_http2-1.15.7-3.module_el8.4.0+778+c970deab.aarch64",
        "Installed: mailcap-2.1.48-3.el8.noarch",
        "Installed: httpd-2.4.37-43.module_el8.5.0+1022+b541f3b1.aarch64"
    ]
}
```
<br>

## 6. Ansible Playbook ì‚¬ìš©í•˜ê¸°
### Ansible Playbook: ì‚¬ìš©ìê°€ ì›í•˜ëŠ” ë‚´ìš©ì„ ë¯¸ë¦¬ ì‘ì„±í•´ ë†“ì€ íŒŒì¼

- ex) ì„¤ì¹˜, íŒŒì¼ ì „ì†¡, ì„œë¹„ìŠ¤ ì¬ì‹œì‘, ...
- ex) ë‹¤ìˆ˜ì˜ ì„œë²„ì— **ë°˜ë³µ ì‘ì—…**ì„ ì²˜ë¦¬í•˜ëŠ” ê²½ìš°
- Playbook
  - **vi first-playbook.yml**
  - ì‹¤í–‰: ansible-playbook first-playbook.yml
  
<br>
<img src="https://github.com/hyewon218/Building-CI-CD-pipelines-with-Jenkins/assets/126750615/472eb2e5-afe4-41f6-8687-679cd7fd9310" width="50%"/><br>

- name -> ë§Œë“¤ê³ ìí•˜ëŠ” Playbook ì´ë¦„
- hosts -> ì ìš©í•˜ê³ ìí•˜ëŠ” ê·¸ë£¹ì˜ ì´ë¦„ or IP address
- tasks -> í•´ë‹¹ íƒ€ê²Ÿì— ì ìš©ì‹œí‚¬ ë‚´ìš©
    - blockinfile: íŒŒì¼ì— blockì„ ë§Œë“¤ì–´ì„œ íŠ¹ì • ë‚´ìš©ì„ ì¶”ê°€
    - path: ì ìš© ìœ„ì¹˜
    - block:`|`í•„ìˆ˜, /etc/ansible/hosts ìœ„ì¹˜ì— ë‘ ì¤„ ì¶”ê°€

<br>

```
[root@b2b74aa4e31b ~]# vi first-playbook.yml
(vi ì…ë ¥ëª¨ë“œ : i)
---
  - name: Add an ansible hosts
    hosts: localhost
    tasks:
      - name: Add a ansible hosts
        blockinfile:
          path: /etc/ansible/hosts
          block: |
            [mygroup]
            172.17.0.5
(ì…ë ¥ í›„ esc ëˆ„ë¥´ê³  :wq!)
[root@b2b74aa4e31b ~]# cat first-playbook.yml (íŒŒì¼ í™•ì¸)
---
  - name: Add an ansible hosts
    hosts: localhost
    tasks:
      - name: Add a ansible hosts
        blockinfile:
          path: /etc/ansible/hosts
          block: |
            [mygroup]
            172.17.0.5
```
<br>

### playbook ì‹¤í–‰
```
ansible-playbook first-playbook.yml
```

<br>

### ê²°ê³¼
```
[root@b2b74aa4e31b ~]# cat /etc/ansible/hosts
[devops]
172.17.0.2
172.17.0.4
[root@b2b74aa4e31b ~]# ansible-playbook first-playbook.yml
[WARNING]: An error occurred while calling ansible.utils.display.initialize_locale (unsupported locale setting).
This may result in incorrectly calculated text widths that can cause Display to print incorrect line lengths

PLAY [Add an ansible hosts] ****************************************************************************************

TASK [Gathering Facts] *********************************************************************************************
ok: [localhost]

TASK [Add a ansible hosts] *****************************************************************************************
changed: [localhost]

PLAY RECAP *********************************************************************************************************
localhost                  : ok=2    changed=1    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   

[root@b2b74aa4e31b ~]# cat /etc/ansible/hosts
[devops]
172.17.0.2
172.17.0.4
# BEGIN ANSIBLE MANAGED BLOCK
[mygroup]
172.17.0.5
# END ANSIBLE MANAGED BLOCK
```
- ë©±ë“±ì„±ì— ì˜í•´ì„œ ë˜‘ê°™ì€ ëª…ë ¹ì–´ë¥¼ ì‹¤í–‰í•´ë„ ê²°ê³¼ê°€ ë³€ê²½ë˜ì§€ ì•ŠëŠ”ë‹¤.
- ê°™ì€ ë™ì‘ì„ ëª‡ ë²ˆ ìƒí–‰í•œë‹¤ í•˜ë”ë¼ë„ í•œ ë²ˆë§Œ ì ìš©ì´ ëœë‹¤.
  ```
  [root@b2b74aa4e31b ~]# ansible-playbook first-playbook.yml (ë˜ í•œë²ˆ ì¶”ê°€)
  [WARNING]: An error occurred while calling ansible.utils.display.initialize_locale (unsupported
  locale setting). This may result in incorrectly calculated text widths that can cause Display to
  print incorrect line lengths

  PLAY [Add an ansible hosts] **********************************************************************

  TASK [Gathering Facts] ***************************************************************************
  ok: [localhost]

  TASK [Add a ansible hosts] ***********************************************************************
  ok: [localhost]

  PLAY RECAP ***************************************************************************************
  localhost                  : ok=2    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0

  [root@b2b74aa4e31b ~]# cat /etc/ansible/hosts
  [devops]
  172.17.0.2
  172.17.0.4
  # BEGIN ANSIBLE MANAGED BLOCK
  [mygroup]
  172.17.0.5 (í•œ ë²ˆë§Œ ì¶”ê°€ë¨)
  # END ANSIBLE MANAGED BLOCK
  ```
  
### Ansible Playbook
#### Ansible Playbook ì˜ˆì œ - íŒŒì¼ ë³µì‚¬
<img src="https://github.com/hyewon218/Building-CI-CD-pipelines-with-Jenkins/assets/126750615/fb1793a8-aed9-4587-a405-b4a4e3ab7b6f" width="60%"/><br>
> ê¸°ì¡´ì— ë‹¨ìˆœí•˜ê²Œ ansibleì´ë¼ëŠ” ì½”ë©˜íŠ¸ë¥¼ ê°€ì§€ê³  ëª¨ë“ˆì„ ì‹¤í–‰í–ˆì—ˆë‹¤ê³  í•˜ë©´ <br>
> ì´ë²ˆì—” playbookì´ë¼ëŠ” ì‘ì„±ë˜ì–´ì§„ ìŠ¤í¬ë¦½íŠ¸ì˜ ë‚´ìš©ì„ ê°€ì§€ê³  ì§€ì •ëœ ì„œë²„ì— ë™ì¼í•œ ì‘ì—…ì„ í•  ìˆ˜ ìˆê²Œ ì œê³µë˜ëŠ” ê¸°ëŠ¥. <br>
> ë” ë§ì€ ëª¨ë“ˆì„ í•œêº¼ë²ˆì— ì‹¤í–‰í•  ìˆ˜ ìˆë‹¤.

<br>

```
- name: Ansible Copy Example Local to Remote
  hosts: devops
  tasks:
    - name: copying file with playbook
      copy:
        src: ~/sample.txt 
        dest: /tmp 
        owner: root
        mode: 0644
```
```
[root@b2b74aa4e31b ~]# vi playbook-sample.yml
ìœ„ íŒŒì¼ ì…ë ¥
[root@b2b74aa4e31b ~]# cat playbook-sample.yml
- name: Ansible Copy Example Local to Remote
  hosts: devops
  tasks:
    - name: copying file with playbook
      copy:
        src: ~/sample.txt 
        dest: /tmp
        owner: root
        mode: 0644
[root@b2b74aa4e31b ~]# cp test.txt sample.txt
[root@b2b74aa4e31b ~]# ls -al *.txt
-rw-r--r-- 1 root root 11 Nov 10 06:19 sample.txt
-rw-r--r-- 1 root root 11 Nov  9 16:48 test.txt
```
```
[root@b2b74aa4e31b ~]# ansible-playbook playbook-sample.yml
[WARNING]: An error occurred while calling ansible.utils.display.initialize_locale (unsupported
locale setting). This may result in incorrectly calculated text widths that can cause Display to
print incorrect line lengths

PLAY [Ansible Copy Example Local to Remote] ******************************************************

TASK [Gathering Facts] ***************************************************************************
ok: [172.17.0.2]
ok: [172.17.0.4]

TASK [copying file with playbook] ****************************************************************
changed: [172.17.0.4]
changed: [172.17.0.2]

PLAY RECAP ***************************************************************************************
172.17.0.2                 : ok=2    changed=1    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   
172.17.0.4                 : ok=2    changed=1    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0
```

<br>

#### Ansible Playbook ì˜ˆì œ - ë‹¤ìš´ë¡œë“œ
```
---
- name: Download Tomcat9 from tomcat.apache.org
  hosts: devops
  tasks:
   - name: Create a Directory /opt/tomcat9
     file:
       path: /opt/tomcat9 (íŒŒì¼ ëª¨ë“ˆì— ì˜í•´ì„œ í•´ë‹¹í•˜ëŠ” í´ë”ê°€ ìƒì„±ì´ ëœë‹¤.)
       state: directory
       mode: 0755
   - name: Download Tomcat using get_url
     get_url:
       url: https://dlcdn.apache.org/tomcat/tomcat-9/v9.0.82/bin/apache-tomcat-9.0.82.tar.gz
       dest: /opt/tomcat9 (ë‹¤ìš´ë¡œë“œ ë°›ì•„ì„œ ì—¬ê¸°ë¡œ ë³µì‚¬)
       mode: 0755
       checksum: sha512:https://downloads.apache.org/tomcat/tomcat-9/v9.0.82/bin/apache-tomcat-9.0.82.tar.gz.sha512
```
```
[root@b2b74aa4e31b ~]# vi playbook-sample2.yml
ìœ„ íŒŒì¼ ì‘ì„±
[root@b2b74aa4e31b ~]# ansible-playbook playbook-sample2.yml
[WARNING]: An error occurred while calling ansible.utils.display.initialize_locale (unsupported locale setting). This may result in incorrectly
calculated text widths that can cause Display to print incorrect line lengths

PLAY [Download Tomcat9 from tomcat.apache.org] *************************************************************************************************

TASK [Gathering Facts] *************************************************************************************************************************
ok: [172.17.0.2]
ok: [172.17.0.4]

TASK [Create a Directory /opt/tomcat9] *********************************************************************************************************
changed: [172.17.0.2]
changed: [172.17.0.4]

TASK [Download Tomcat using get_url] ***********************************************************************************************************
changed: [172.17.0.4]
changed: [172.17.0.2]

PLAY RECAP *************************************************************************************************************************************
172.17.0.2                 : ok=3    changed=2    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   
172.17.0.4                 : ok=3    changed=2    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0
```
<br>

## 7. Jenkins + Ansible ì—°ë™í•˜ê¸°
> ì§€ê¸ˆë¶€í„°ëŠ” Ansibleê³¼ Ansible playbookì„ ì´ìš©í•´ì„œ Jenkinsì—ì„œ í™œìš©í•˜ëŠ” ë°©ë²•<br>
> ì»¨í…Œì´ë„ˆ ì¤‘ë³µ ë¬¸ì œë¥¼ Ansibleì„ í†µí•´ í•´ê²°

<br>

### Setup Ansible on Jenkins
- Manage Jenkins -> Configure System -> Publish on SSH
  <img src="https://github.com/hyewon218/Building-CI-CD-pipelines-with-Jenkins/assets/126750615/3d96c39f-5a57-452c-bec1-85618e3932be" width="60%"/><br>
  - Port ëŠ” í˜„ì¬ Jenkins ì„œë²„ì—ì„œ Ansible ì„œë²„ë¡œ ssh ì ‘ì†ì´ë¯€ë¡œ 20022ê°€ ì•„ë‹Œ 22ë¥¼ í†µí•´ ì ‘ì†

<br>

> ì´ì œ ê·¸ë™ì•ˆ ë§Œë“¤ì—ˆë˜ jenkinsì˜ í”„ë¡œì íŠ¸ë¥¼ ansibleì„ ì´ìš©í•´ì„œ ë°°í¬í•˜ëŠ” ì‘ì—…ì„ í•´ë³´ì!

<br>

## 8. Jenkins + Ansible Playbook ì‚¬ìš©í•˜ê¸°
### Ansible í”„ë¡œì íŠ¸ ìƒì„±
<img src="https://github.com/hyewon218/Building-CI-CD-pipelines-with-Jenkins/assets/126750615/4d00d329-65d5-4b2d-87ce-b16d0bbbfd6e" width="60%"/><br>
<br>
### ë¹Œë“œ í›„ ì¡°ì¹˜
<img src="https://github.com/hyewon218/Building-CI-CD-pipelines-with-Jenkins/assets/126750615/fe8e4096-6ea1-41d9-b6d9-f98cd655da6d" width="60%"/><br>
- Jenkinsì—ì„œ ìƒì„±í•œ war íŒŒì¼ì„ Ansible ì„œë²„ì— ë³µì‚¬
<br>

### ë¹Œë“œ

```
[root@c6caaa1f3878 ~]# docker images
Cannot connect to the Docker daemon at unix:///var/run/docker.sock. Is the docker daemon running?
[root@c6caaa1f3878 ~]# systemctl enable docker
Created symlink /etc/systemd/system/multi-user.target.wants/docker.service â†’ /usr/lib/systemd/system/docker.service.
[root@c6caaa1f3878 ~]# systemctl status docker
â— docker.service - Docker Application Container Engine
   Loaded: loaded (/usr/lib/systemd/system/docker.service; enabled; vendor preset: >
   Active: inactive (dead)
     Docs: https://docs.docker.com
[root@c6caaa1f3878 ~]# systemctl start docker
[root@c6caaa1f3878 ~]# systemctl status docker
â— docker.service - Docker Application Container Engine
   Loaded: loaded (/usr/lib/systemd/system/docker.service; enabled; vendor preset: >
   Active: active (running) since Fri 2023-11-10 16:16:13 UTC; 7s ago
     Docs: https://docs.docker.com
 Main PID: 1842 (dockerd)
    Tasks: 10
   Memory: 29.7M
   CGroup: /docker/c6caaa1f3878f770c3028da8883e0331d090901301ff59a6d85fd5fe4480cb6d>
           â””â”€1842 /usr/bin/dockerd -H fd:// --containerd=/run/containerd/containerd>

Nov 10 16:16:13 c6caaa1f3878 dockerd[1842]: time="2023-11-10T16:16:13.316127921Z" l>
Nov 10 16:16:13 c6caaa1f3878 dockerd[1842]: time="2023-11-10T16:16:13.327270713Z" l>
Nov 10 16:16:13 c6caaa1f3878 dockerd[1842]: time="2023-11-10T16:16:13.560479380Z" l>
Nov 10 16:16:13 c6caaa1f3878 dockerd[1842]: time="2023-11-10T16:16:13.577734171Z" l>
Nov 10 16:16:13 c6caaa1f3878 dockerd[1842]: time="2023-11-10T16:16:13.608634171Z" l>
Nov 10 16:16:13 c6caaa1f3878 dockerd[1842]: time="2023-11-10T16:16:13.660848421Z" l>
Nov 10 16:16:13 c6caaa1f3878 dockerd[1842]: time="2023-11-10T16:16:13.693822546Z" l>
Nov 10 16:16:13 c6caaa1f3878 dockerd[1842]: time="2023-11-10T16:16:13.693904755Z" l>
Nov 10 16:16:13 c6caaa1f3878 systemd[1]: Started Docker Application Container Engin>
Nov 10 16:16:13 c6caaa1f3878 dockerd[1842]: time="2023-11-10T16:16:13.720719755Z" l>
```

<br>

**ansible ì„œë²„**
```
choihyewon@choehyewon-ui-noteubug ~ % docker ps -a
CONTAINER ID   IMAGE                          COMMAND                   CREATED        STATUS                  PORTS                                              NAMES
b2b74aa4e31b   edowon0623/ansible-server:m1   "/sbin/init systemctâ€¦"   37 hours ago   Up 37 hours             0.0.0.0:20022->22/tcp, 0.0.0.0:8082->8080/tcp      ansible-server
c6caaa1f3878   edowon0623/docker-server:m1    "/sbin/init systemctâ€¦"   3 days ago     Up 37 hours             0.0.0.0:10022->22/tcp, 0.0.0.0:8081->8080/tcp      docker-server
67df6243d635   jenkins/jenkins:lts-jdk17      "/usr/bin/tini -- /uâ€¦"   7 days ago     Up 37 hours             0.0.0.0:8080->8080/tcp, 0.0.0.0:50000->50000/tcp   jenkins-server
92c4fd45f228   postgres                       "docker-entrypoint.sâ€¦"   3 months ago   Exited (0) 6 days ago                                                      postgres_boot
choihyewon@choehyewon-ui-noteubug ~ % ssh root@localhost -p 20022
root@localhost's password: 
Last failed login: Fri Nov 10 12:28:31 UTC 2023 from 172.17.0.3 on ssh:notty
There was 1 failed login attempt since the last successful login.
Last login: Fri Nov 10 12:15:19 2023 from 172.17.0.3
[root@b2b74aa4e31b ~]# ls -al
total 7920
dr-xr-x--- 1 root root    4096 Nov 10 16:32 .
drwxr-xr-x 1 root root    4096 Nov 10 07:27 ..
drwxr-xr-x 4 root root    4096 Nov  9 15:58 .ansible
-rw------- 1 root root    1715 Nov 10 16:10 .bash_history
-rw-r--r-- 1 root root      18 May 11  2019 .bash_logout
-rw-r--r-- 1 root root     176 May 11  2019 .bash_profile
-rw-r--r-- 1 root root     176 May 11  2019 .bashrc
drwxr-xr-x 1 root root    4096 Jul 31  2022 .cache
-rw-r--r-- 1 root root     100 May 11  2019 .cshrc
drwx------ 2 root root    4096 Nov  9 09:09 .ssh
-rw-r--r-- 1 root root     129 May 11  2019 .tcshrc
-rw-r--r-- 1 root root     129 Jul 31  2022 Dockerfile
-rw------- 1 root root    2365 Sep 15  2021 anaconda-ks.cfg
-rw-r--r-- 1 root root     608 Sep 15  2021 anaconda-post.log
-rw-r--r-- 1 root root     221 Nov 10 05:25 first-playbook.yml
-rw-r--r-- 1 root root 8025902 Nov 10 16:32 hello-world.war
-rw------- 1 root root    2062 Sep 15  2021 original-ks.cfg
-rw-r--r-- 1 root root     205 Nov 10 06:16 playbook-sample.yml
-rw-r--r-- 1 root root     506 Nov 10 07:24 playbook-sample2.yml
-rw-r--r-- 1 root root      11 Nov 10 06:19 sample.txt
-rw-r--r-- 1 root root      11 Nov  9 16:48 test.txt
```
- hello-world.war íŒŒì¼ì´ ë³µì‚¬ê°€ ë˜ì—ˆë‹¤.<br>
  <img src="https://github.com/hyewon218/Building-CI-CD-pipelines-with-Jenkins/assets/126750615/407cc25b-a270-422e-b9b2-5394f1f31571" width="60%"/><br>

### Create an ansible playbook file
#### vi first-devops-playbook.yml
```
- hosts: all
#   become: true  

  tasks:
  - name: build a docker image with deployed war file
    command: docker build -t cicd-project-ansible . 
    args: 
        chdir: /root 
```
- all : ì „ì²´ ëŒ€ìƒ
- tasks : war íŒŒì¼ì„ í†µí•´ ë„ì»¤ ì´ë¯¸ì§€ ìƒì„±
  - args: chdir -> ì‘ì—… í•  ëŒ€ìƒ : /root ë””ë ‰í† ë¦¬ -> default ìœ„ì¹˜ì¸ /etc/ansible/hostsê°€ ì•„ë‹Œ <br>
ì§ì ‘ **inventory**ë¥¼ ëª…ì‹œí•˜ëŠ” ë°©ë²•(ì´ í”„ë¡œì íŠ¸ ë‚´ì—ì„œ ì„ì‹œë¡œ ì‚¬ìš©í•˜ê³ ì í•˜ëŠ” í˜¸ìŠ¤íŠ¸ ë“±ë¡)
```
[root@b2b74aa4e31b ~]# vi first-devops-playbook.yml
[root@b2b74aa4e31b ~]# ls -al
total 7924
dr-xr-x--- 1 root root    4096 Nov 10 16:50 .
drwxr-xr-x 1 root root    4096 Nov 10 16:40 ..
drwxr-xr-x 4 root root    4096 Nov  9 15:58 .ansible
-rw------- 1 root root    1715 Nov 10 16:10 .bash_history
-rw-r--r-- 1 root root      18 May 11  2019 .bash_logout
-rw-r--r-- 1 root root     176 May 11  2019 .bash_profile
-rw-r--r-- 1 root root     176 May 11  2019 .bashrc
drwxr-xr-x 1 root root    4096 Jul 31  2022 .cache
-rw-r--r-- 1 root root     100 May 11  2019 .cshrc
drwx------ 2 root root    4096 Nov  9 09:09 .ssh
-rw-r--r-- 1 root root     129 May 11  2019 .tcshrc
-rw-r--r-- 1 root root     129 Jul 31  2022 Dockerfile
-rw------- 1 root root    2365 Sep 15  2021 anaconda-ks.cfg
-rw-r--r-- 1 root root     608 Sep 15  2021 anaconda-post.log
-rw-r--r-- 1 root root     179 Nov 10 16:50 first-devops-playbook.yml
-rw-r--r-- 1 root root     221 Nov 10 05:25 first-playbook.yml
-rw-r--r-- 1 root root 8025902 Nov 10 16:44 hello-world.war
-rw------- 1 root root    2062 Sep 15  2021 original-ks.cfg
-rw-r--r-- 1 root root     205 Nov 10 06:16 playbook-sample.yml
-rw-r--r-- 1 root root     506 Nov 10 07:24 playbook-sample2.yml
-rw-r--r-- 1 root root      11 Nov 10 06:19 sample.txt
-rw-r--r-- 1 root root      11 Nov  9 16:48 test.txt
[root@b2b74aa4e31b ~]# cat Dockerfile
FROM tomcat:9.0

LABEL org.opencontainers.image.authors="edowon0623@gmail.com"

COPY ./hello-world.war /usr/local/tomcat/webapps
[root@b2b74aa4e31b ~]# cat first-devops-playbook.yml
- hosts: all
#   become: true  

  tasks:
  - name: build a docker image with deployed war file
    command: docker build -t cicd-project-ansible .
    args:
        chdir: /root
```
<br>

### Create a hosts file
#### vi hosts
```
172.17.0.4
```
- ansible ì„œë²„<br>
  <img src="https://github.com/hyewon218/Building-CI-CD-pipelines-with-Jenkins/assets/126750615/632dabc2-ff7c-485b-8779-5aaa623cbc96" width="30%"/><br>

<br>

### playbook ì‹¤í–‰
```
ansible-playbook -i hosts first-devops-playbook.yml
```
- -i hosts : inventoryë¥¼ ì§€ì •í•´ì£¼ëŠ” ì˜µì…˜
- host : ë°©ê¸ˆ ë§Œë“¤ì—ˆë˜ inventory xml íŒŒì¼

```
[root@b2b74aa4e31b ~]# pwd
/root
[root@b2b74aa4e31b ~]# vi hosts
[root@b2b74aa4e31b ~]# ansible-playbook -i hosts first-devops-playbook.yml
[WARNING]: An error occurred while calling ansible.utils.display.initialize_locale
(unsupported locale setting). This may result in incorrectly calculated text widths that can
cause Display to print incorrect line lengths

PLAY [all] ************************************************************************************

TASK [Gathering Facts] ************************************************************************
ok: [172.17.0.4]

TASK [build a docker image with deployed war file] ********************************************
changed: [172.17.0.4]

PLAY RECAP ************************************************************************************
172.17.0.4                 : ok=2    changed=1    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0

[root@b2b74aa4e31b ~]# docker images
REPOSITORY             TAG       IMAGE ID       CREATED              SIZE
cicd-project-ansible   latest    73362b4d5e6d   About a minute ago   463MB
tomcat                 9.0       349050649a53   10 days ago          455MB
```
- cicd-project-ansible ì´ë¯¸ì§€ê°€ ìƒì„±ë¨<br>
  
<img src="https://github.com/hyewon218/Building-CI-CD-pipelines-with-Jenkins/assets/126750615/63903bc5-133a-459b-b1e0-32fbbef46e87" width="60%"/><br>

<br>

### ìƒì„±í•œ ì´ë¯¸ì§€ë¥¼ ì»¨í…Œì´ë„ˆë¡œ ë§Œë“œëŠ” ì‘ì—…ê¹Œì§€ ì¶”ê°€
#### vi first-devops-playbook.yml  ìˆ˜ì •
```
choihyewon@choehyewon-ui-noteubug ~ % docker ps -a
CONTAINER ID   IMAGE                          COMMAND                   CREATED        STATUS                  PORTS                                              NAMES
b2b74aa4e31b   edowon0623/ansible-server:m1   "/sbin/init systemctâ€¦"   38 hours ago   Up 38 hours             0.0.0.0:20022->22/tcp, 0.0.0.0:8082->8080/tcp      ansible-server
c6caaa1f3878   edowon0623/docker-server:m1    "/sbin/init systemctâ€¦"   3 days ago     Up 38 hours             0.0.0.0:10022->22/tcp, 0.0.0.0:8081->8080/tcp      docker-server
67df6243d635   jenkins/jenkins:lts-jdk17      "/usr/bin/tini -- /uâ€¦"   7 days ago     Up 38 hours             0.0.0.0:8080->8080/tcp, 0.0.0.0:50000->50000/tcp   jenkins-server
```
```
choihyewon@choehyewon-ui-noteubug ~ % docker ps -a
CONTAINER ID   IMAGE                          COMMAND                   CREATED        STATUS                  PORTS                                              NAMES
b2b74aa4e31b   edowon0623/ansible-server:m1   "/sbin/init systemctâ€¦"   38 hours ago   Up 38 hours             0.0.0.0:20022->22/tcp, 0.0.0.0:8082->8080/tcp      ansible-server
c6caaa1f3878   edowon0623/docker-server:m1    "/sbin/init systemctâ€¦"   3 days ago     Up 38 hours             0.0.0.0:10022->22/tcp, 0.0.0.0:8081->8080/tcp      docker-server
67df6243d635   jenkins/jenkins:lts-jdk17      "/usr/bin/tini -- /uâ€¦"   7 days ago     Up 38 hours             0.0.0.0:8080->8080/tcp, 0.0.0.0:50000->50000/tcp   jenkins-server
```

<img src="https://github.com/hyewon218/Building-CI-CD-pipelines-with-Jenkins/assets/126750615/9932b055-5827-4ef6-a4e2-a5d1ae324e66" width="60%"/><br>

<br>

```
[root@b2b74aa4e31b ~]# docker images
REPOSITORY             TAG       IMAGE ID       CREATED          SIZE
cicd-project-ansible   latest    73362b4d5e6d   28 minutes ago   463MB
tomcat                 9.0       349050649a53   10 days ago      455MB
[root@b2b74aa4e31b ~]# docker ps -a
CONTAINER ID   IMAGE     COMMAND   CREATED   STATUS    PORTS     NAMES
[root@b2b74aa4e31b ~]# ansible-playbook -i hosts first-devops-playbook.yml
[WARNING]: An error occurred while calling ansible.utils.display.initialize_locale (unsupported
locale setting). This may result in incorrectly calculated text widths that can cause Display to
print incorrect line lengths

PLAY [all] *****************************************************************************************

TASK [Gathering Facts] *****************************************************************************
ok: [172.17.0.4]

TASK [build a docker image with deployed war file] *************************************************
changed: [172.17.0.4]

TASK [create a container using cicd-project-ansible image] *****************************************
changed: [172.17.0.4]

PLAY RECAP *****************************************************************************************
172.17.0.4                 : ok=3    changed=2    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   

[root@b2b74aa4e31b ~]# docker images
REPOSITORY             TAG       IMAGE ID       CREATED          SIZE
cicd-project-ansible   latest    73362b4d5e6d   30 minutes ago   463MB
tomcat                 9.0       349050649a53   10 days ago      455MB
[root@b2b74aa4e31b ~]# docker ps -a
CONTAINER ID   IMAGE                  COMMAND             CREATED              STATUS              PORTS                    NAMES
b93263ef3b5f   cicd-project-ansible   "catalina.sh run"   About a minute ago   Up About a minute   0.0.0.0:8080->8080/tcp   my_cicd_project
```

<img src="https://github.com/hyewon218/Building-CI-CD-pipelines-with-Jenkins/assets/126750615/8e4530c2-9112-4f75-81cc-6e207162507b" width="60%"/><br>

<br>

### ì¶”ê°€í–ˆë˜ ì»¨í…Œì´ë„ˆ, ì´ë¯¸ì§€ ì‚­ì œ
```
[root@b2b74aa4e31b ~]# docker images
REPOSITORY             TAG       IMAGE ID       CREATED          SIZE
cicd-project-ansible   latest    73362b4d5e6d   30 minutes ago   463MB
tomcat                 9.0       349050649a53   10 days ago      455MB
[root@b2b74aa4e31b ~]# docker ps -a
CONTAINER ID   IMAGE                  COMMAND             CREATED              STATUS              PORTS                    NAMES
b93263ef3b5f   cicd-project-ansible   "catalina.sh run"   About a minute ago   Up About a minute   0.0.0.0:8081->8080/tcp   my_cicd_project
[root@b2b74aa4e31b ~]# docker stop my_cicd_project
my_cicd_project
[root@b2b74aa4e31b ~]# docker rm my_cicd_project
my_cicd_project
[root@b2b74aa4e31b ~]# docker rmi cicd-project-ansible
Untagged: cicd-project-ansible:latest
Deleted: sha256:73362b4d5e6df4e4317c5c9fe221dbc74b42078b73905322aa869b4f5e18d4bc
Deleted: sha256:9ccd4e82271eb5bbb6afbec6207b5ab62bbf7135493fd2b535fc49bfc96fd5d7
Deleted: sha256:af3ac1cf5d589ee4caa82869577c8fd49acf73364626c0938f7cfad3323124ef
[root@b2b74aa4e31b ~]# docker ps -a
CONTAINER ID   IMAGE     COMMAND   CREATED   STATUS    PORTS     NAMES
[root@b2b74aa4e31b ~]# docker images
REPOSITORY   TAG       IMAGE ID       CREATED       SIZE
tomcat       9.0       349050649a53   10 days ago   455MB
```
```
[root@b2b74aa4e31b ~]# ls -al *.yml
-rw-r--r-- 1 root root 338 Nov 10 17:26 first-devops-playbook.yml
-rw-r--r-- 1 root root 221 Nov 10 05:25 first-playbook.yml
-rw-r--r-- 1 root root 205 Nov 10 06:16 playbook-sample.yml
-rw-r--r-- 1 root root 506 Nov 10 07:24 playbook-sample2.yml
```
> ğŸ§‘ğŸ»â€ğŸ« ìœ„ì˜ ì‘ì—…ì„ ì´ì œ Jenkins ì—ì„œ ì»¤ë§¨ë“œë¥¼ í†µí•´ ì‹¤í–‰
first-devops-playbook.yml ì´ íŒŒì¼ì„ jenkinsì—ì„œ ì‹¤í–‰í•  ìˆ˜ ìˆë„ë¡ ì§€ì •

<br>

### Exec command ìˆ˜ì •
```
ansible-playbook -i hosts first-devops-playbook.yml
```
<img src="https://github.com/hyewon218/Building-CI-CD-pipelines-with-Jenkins/assets/126750615/327d436a-d509-4984-ab23-1f3f65abebaa" width="60%"/><br>
#### ë‹¤ì‹œ ë¹Œë“œ â†’ ì„±ê³µ
```
[root@b2b74aa4e31b ~]# docker ps -a
CONTAINER ID   IMAGE                  COMMAND             CREATED              STATUS              PORTS                    NAMES
c70c99135285   cicd-project-ansible   "catalina.sh run"   About a minute ago   Up About a minute   0.0.0.0:8081->8080/tcp   my_cicd_project
[root@b2b74aa4e31b ~]# docker images
REPOSITORY             TAG       IMAGE ID       CREATED              SIZE
cicd-project-ansible   latest    6af35e6035a0   About a minute ago   463MB
tomcat                 9.0       349050649a53   10 days ago          455MB
```
- ì»¨í…Œì´ë„ˆì™€ ì´ë¯¸ì§€ ë‘˜ ë‹¤ ì˜ ë§Œë“¤ì–´ì¡Œë‹¤.

<br>

> ğŸ§‘ğŸ»â€ğŸ« ì—¬ëŸ¬ë²ˆ ì†ŒìŠ¤ë¥¼ ë³€ê²½í–ˆì„ ë•Œ ë³€ê²½ëœ ë‚´ìš©ì„ ìë™ìœ¼ë¡œ ê°€ì§€ê³  ì™€ì„œ ì´ë¯¸ì§€ ë¹Œë“œí•˜ëŠ” ì‘ì—…ê¹Œì§€!
> 
<img src="https://github.com/hyewon218/Building-CI-CD-pipelines-with-Jenkins/assets/126750615/e4356300-c9e0-4c09-a6e9-a6e59a604d2a" width="60%"/><br>
- 1ë¶„ì— í•œë²ˆ ì”© ìë™ìœ¼ë¡œ ê°€ì ¸ì˜¤ë„ë¡<br>
  <img src="https://github.com/hyewon218/Building-CI-CD-pipelines-with-Jenkins/assets/126750615/01b87f0f-e62f-46f7-b46e-2f234d6dcde1" width="60%"/><br>
  #### ìë™ ë¹Œë“œ â†’ ì‹¤íŒ¨
  <img src="https://github.com/hyewon218/Building-CI-CD-pipelines-with-Jenkins/assets/126750615/5889465a-d757-4865-86ea-7414d52f72ee" width="60%"/><br>
  ```
  [root@b2b74aa4e31b ~]# docker images
  REPOSITORY             TAG       IMAGE ID       CREATED          SIZE
  cicd-project-ansible   latest    c3b58530f95d   2 minutes ago    463MB
  <none>                 <none>    c679d8c0e1cb   16 minutes ago   463MB
  tomcat                 9.0       349050649a53   10 days ago      455MB
  ```
  ```
  [root@b2b74aa4e31b ~]# docker ps -a
  CONTAINER ID   IMAGE          COMMAND             CREATED          STATUS          PORTS                    NAMES
  6bf1e4b36b39   c679d8c0e1cb   "catalina.sh run"   16 minutes ago   Up 16 minutes   0.0.0.0:8080->8080/tcp   my_cicd_project
  ```
  - ì»¨í…Œì´ë„ˆê°€ ì¡´ì¬í•˜ê³  ìˆê¸° ë•Œë¬¸ì— ë‘ ë²ˆ ì—°ì† ë§Œë“¤ ìˆ˜ ì—†ë‹¤ â†’ unstable
  - ê¸°ì¡´ì— ë§Œë“¤ì–´ì¡Œë˜ ì»¨í…Œì´ë„ˆë¥¼ ì¤‘ì§€, ì‚­ì œ, ìƒˆë¡­ê²Œ ì»¨í…Œì´ë„ˆ ë§Œë“¤ê¸°

<br>

### ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì¤‘ì§€ â€¢ ì‚­ì œ ì‘ì—… ì¶”ê°€
#### vi first-devops-playbook.yml
```
- hosts: all
#   become: true

  tasks:
  - name: stop current running container
    command: docker stop my_cicd_project
    ignore_errors: yes

  - name: remove stopped cotainer
    command: docker rm my_cicd_project
    ignore_errors: yes

  - name: remove current docker image
    command: docker rmi cicd-project-ansible
    ignore_errors: yes

  - name: build a docker image with deployed war file
    command: docker build -t cicd-project-ansible .
    args:
        chdir: /root
  - name: create a container using cicd-project-ansible image
    command: docker run --privileged -d --name my_cicd_project -p 8080:8080 cicd-project-ansible
```
- name: stop current running container
  - ì‘ë™ ì¤‘ì¸ ì»¨í…Œì´ë„ˆê°€ ìˆë‹¤ë©´ stop
  - ì‘ë™ ì¤‘ì¸ ì»¨í…Œì´ë„ˆê°€ ì—†ë‹¤ë©´ exceptionì´ ë°œìƒí•  ìˆ˜ ìˆê¸° ë•Œë¬¸ì— ignore_errors: yesë¥¼ í†µí•´ ë¬´ì‹œ
- name: remove stopped cotainer
  - ì¤‘ì§€ëœ ì»¨í…Œì´ë„ˆë¥¼ ì‚­ì œ
- name: remove current docker image
  - ì´ë¯¸ì§€ ì‚­ì œ
- name: build a docker image with deployed war file
  - ì´ë¯¸ì§€ ìƒˆë¡œ ë¹Œë“œ
- name: create a container using cicd-project-ansible image
  - ì´ë¯¸ì§€ë¥¼ í†µí•´ ì»¨í…Œì´ë„ˆ ìƒˆë¡œ ìƒì„± í›„ ê¸°ë™

<br>

#### ë¹Œë“œ â†’ ì„±ê³µ
<img src="https://github.com/hyewon218/Building-CI-CD-pipelines-with-Jenkins/assets/126750615/10535f4e-25c9-47b9-9228-71c1683e2e7d" width="60%"/><br>

#### ë‹¤ì‹œ ë¹Œë“œ â†’ ì„±ê³µ
```
[root@b2b74aa4e31b ~]# docker images
REPOSITORY             TAG       IMAGE ID       CREATED          SIZE
cicd-project-ansible   latest    487d727b50e4   3 seconds ago    463MB
<none>                 <none>    c679d8c0e1cb   32 minutes ago   463MB
tomcat                 9.0       349050649a53   10 days ago      455MB
[root@b2b74aa4e31b ~]# docker ps -a
CONTAINER ID   IMAGE                  COMMAND             CREATED         STATUS         PORTS                    NAMES
37d86baf1bb1   cicd-project-ansible   "catalina.sh run"   9 seconds ago   Up 8 seconds   0.0.0.0:8080->8080/tcp   my_cicd_project
```